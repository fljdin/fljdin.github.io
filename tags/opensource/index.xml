<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Opensource on Carnet de découvertes</title><link>https://fljd.in/tags/opensource/</link><description>Recent content in Opensource on Carnet de découvertes</description><generator>Hugo -- gohugo.io</generator><language>fr</language><managingEditor>Florent Jardin</managingEditor><lastBuildDate>Tue, 30 Jul 2024 09:30:00 +0000</lastBuildDate><atom:link href="https://fljd.in/tags/opensource/index.xml" rel="self" type="application/rss+xml"/><item><title>Faire vivre une communauté</title><link>https://fljd.in/2024/07/30/faire-vivre-une-communaute/</link><pubDate>Tue, 30 Jul 2024 09:30:00 +0000</pubDate><author>Florent Jardin</author><guid>https://fljd.in/2024/07/30/faire-vivre-une-communaute/</guid><description>&lt;p>Le &lt;a href="https://pgday.fr/" target="_blank" rel="noopener">PG Day France&lt;/a> s&amp;rsquo;est tenu les 11 et 12 juin derniers à Lille, ma ville natale.
Il s&amp;rsquo;agit de l&amp;rsquo;événement de la communauté française de PostgreSQL qui pose ses valises dans une
ville différente chaque année. L&amp;rsquo;occasion était trop belle pour moi et j&amp;rsquo;y ai rencontré de nombreuses
personnes venant de toute la France et de ses alentours, pour discuter de PostgreSQL au cours
de deux jours d&amp;rsquo;ateliers et de conférences.&lt;/p>
&lt;p>Pour cette édition, j&amp;rsquo;ai eu le plaisir de prendre la parole et de faire un retour d&amp;rsquo;expérience
sur l&amp;rsquo;animation du groupe Meetup local dont j&amp;rsquo;ai repris les rennes il y a maintenant quatre ans.
Dans cet article, je souhaite retranscrire les principaux points abordés lors de cette présentation,
en attendant que la vidéo de la conférence soit mise en ligne.&lt;/p>
&lt;div class="message">Le support de ma présentation est &lt;a href="https://fljd.in/documents/pgdayfr-faire-vivre-une-communaute.pdf">disponible à cette adresse&lt;/a>.&lt;/div>
&lt;hr>
&lt;h2 id="quest-ce-quun-pug-">Qu&amp;rsquo;est-ce qu&amp;rsquo;un PUG ?&lt;/h2>
&lt;p>Un « PUG » est un groupe d&amp;rsquo;utilisateur·rices de PostgreSQL, ou « PostgreSQL User Group » en anglais.
Réunis régulièrement pour échanger autour de PostgreSQL, les PUGs sont des lieux de rencontres
et d&amp;rsquo;apprentissage pour les personnes intéressées par ce système de gestion de base de données. Ces
communautés locales sont fréquentes, particulièrement pour les logiciels libres, et permettent de
fédérer les utilisateurs et utilisatrices autour d&amp;rsquo;un même outil.&lt;/p>
&lt;p>À Lille, nous avons la chance d&amp;rsquo;avoir un tissu économique très dynamique, avec de nombreuses communautés,
telles que le &lt;a href="https://www.meetup.com/fr-FR/chtijug/" target="_blank" rel="noopener">Ch&amp;rsquo;ti JUG&lt;/a> (&lt;em>Java User Group&lt;/em>), le &lt;a href="https://www.meetup.com/GDG-Lille/" target="_blank" rel="noopener">GDG Lille&lt;/a> (&lt;em>Google Developer Group&lt;/em>), &lt;a href="https://www.meetup.com/fr-FR/nord-agile/" target="_blank" rel="noopener">Nord Agile&lt;/a>
ou encore &lt;a href="https://www.meetup.com/Software-Craftsmanship-Lille/" target="_blank" rel="noopener">Software Craft Lille&lt;/a>. Quoi de plus naturel que de vouloir proposer à une poignée de
ce public des rencontres autour de PostgreSQL ?&lt;/p>
&lt;p>Une &lt;a href="https://www.postgresql.org/community/user-groups/" target="_blank" rel="noopener">page du projet&lt;/a> PostgreSQL recense les différents PUGs à travers le monde, et il est possible
d&amp;rsquo;y trouver des groupes dans de nombreux pays, dont la France. À l&amp;rsquo;heure de la rédaction de ma conférence,
je dénombrais 62 groupes mondiaux, dont 5 en France : Paris, Lyon, Nantes (non référencée), Toulouse et Lille.&lt;/p>
&lt;p>La plateforme Meetup est souvent utilisée pour organiser les rencontres, et pour preuve, 46 PUGs y sont
affiliés. Il s&amp;rsquo;agit d&amp;rsquo;une commodité depuis plus de 10 ans, et la plupart des groupes français y sont inscrits.&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2024-07-30-carte-de-france-des-pugs.png" alt="Carte de France des PUGs">&lt;/p>
&lt;p>La création d&amp;rsquo;un PUG reconnu par la communauté internationale est un processus simple, qui nécessite
de constituer un groupe d&amp;rsquo;organisation et de postuler à l&amp;rsquo;adresse e-mail &lt;code>usergroups@postgresql.org&lt;/code>.
Le groupe doit respecter un certain nombre de règles, prévues par la &lt;a href="https://www.postgresql.org/about/policies/user-groups/" target="_blank" rel="noopener">charte des PUGs&lt;/a>, et doit
s&amp;rsquo;engager à respecter les valeurs de la communauté PostgreSQL. En substance, voici les points qu&amp;rsquo;il
faut retenir :&lt;/p>
&lt;ul>
&lt;li>Le groupe doit être ouvert à tous et toutes, sans discrimination.&lt;/li>
&lt;li>Les rencontres doivent être proposées &lt;em>a minima&lt;/em> une fois tous les deux ans.&lt;/li>
&lt;li>Les rencontres ne doivent pas faire l&amp;rsquo;objet d&amp;rsquo;un accord de confidentialité (NDA).&lt;/li>
&lt;li>Les rencontres sont rattachées à la zone géographique du groupe.&lt;/li>
&lt;li>Une entreprise ne peut pas être représentée à 50% ou plus dans le comité d&amp;rsquo;organisation.&lt;/li>
&lt;li>La sélection des conférences est à la discrétion du comité d&amp;rsquo;organisation.&lt;/li>
&lt;li>Les entreprises peuvent promouvoir leurs produits et leurs services, si leurs activités facilitent
l&amp;rsquo;adoption de PostgreSQL et si les contenus présentés sont de nature technique.&lt;/li>
&lt;li>Le groupe doit divulguer le nom des sponsors, et peut les mentionner en introduction des rencontres.&lt;/li>
&lt;li>Le PUG doit adopter un code de conduite et peut utiliser &lt;a href="https://www.postgresql.org/about/policies/coc/fr/" target="_blank" rel="noopener">celui de la communauté PostgreSQL&lt;/a>.&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="genèse-du-groupe">Genèse du groupe&lt;/h2>
&lt;p>Le groupe Meetup PostgreSQL Lille a été fondé le 25 février 2016 sur la plateforme éponyme. À l&amp;rsquo;époque,
l&amp;rsquo;idée de reproduire le format des Meetup à Paris était partagée entre Guillaume Lelarge et Pierre Hilbert,
deux lillois qui se croisaient régulièrement aux événements. L&amp;rsquo;une des principales motivations était de
participer à la promotion du logiciel libre avec un partage de retours d&amp;rsquo;expérience pour inspirer les autres
acteurs locaux.&lt;/p>
&lt;p>À cette période, je fréquentais moi-même les événements organisés par le groupe Meetup Oracle Paris et Province,
et je suivais avec attention les conférences autour de PostgreSQL dans ma région. La première rencontre
du groupe PG Lille a eu lieu le &lt;a href="https://www.meetup.com/meetup-postgresql-lille/events/231446425/" target="_blank" rel="noopener">24 juin 2016&lt;/a>, dans les locaux de Decathlon Campus (Villeneuve D&amp;rsquo;Ascq, 59).
J&amp;rsquo;ai été séduit par le format et l&amp;rsquo;ambiance décontractée, et j&amp;rsquo;en ai gardé un excellent souvenir.&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2024-07-30-premier-meetup-pg-lille.png" alt="Premier Meetup PG Lille">&lt;/p>
&lt;p>Cependant, la régularité des rencontres n&amp;rsquo;a pas été au rendez-vous du projet. L&amp;rsquo;événement suivant fut planifié
plus d&amp;rsquo;une année plus tard, le 17 octobre 2017 et ce fut le seul auquel je n&amp;rsquo;ai pas pu participer. Les impératifs
professionnels de Guillaume et de Pierre ne leur ont pas permis de maintenir le rythme, et le groupe a été
laissé en sommeil pendant plus de trois années.&lt;/p>
&lt;p>C&amp;rsquo;est en 2019 que j&amp;rsquo;ai pris la décision de reprendre le flambeau, en proposant à Pierre de me transmettre
les droits d&amp;rsquo;administration du groupe. Mon arrivée chez Dalibo en tant que consultant PostgreSQL m&amp;rsquo;a donné
l&amp;rsquo;opportunité de faire la rencontre d&amp;rsquo;experts passionnés, notamment Guillaume Lelarge et Stefan Fercot,
qui m&amp;rsquo;ont encouragé à reprendre le projet.&lt;/p>
&lt;p>Fort d&amp;rsquo;un réseau professionnel de qualité sur Twitter à l&amp;rsquo;époque, j&amp;rsquo;ai pu rapidement mobiliser une équipe
de bénévoles pour organiser le Meetup du &lt;a href="https://www.meetup.com/meetup-postgresql-lille/events/267319389/" target="_blank" rel="noopener">28 janvier 2020&lt;/a>. J&amp;rsquo;ai pu compter sur le soutien de Stefan Fercot
(Dalibo), de Stéphane Definin (Think) et de Sébastien Freiss (SFEIR) pour faire de cette reprise un petit
succès.&lt;/p>
&lt;p>&amp;hellip; Malheureusement, en mars de cette même année, la pandémie de COVID-19 a contraint le groupe à suspendre
ses projets et je n&amp;rsquo;ai pas eu le courage de proposer des contenus en ligne, au grand dam des membres du groupe.
Pour l&amp;rsquo;anecdote, aucun autre groupe Meetup de France n&amp;rsquo;a été épargné par la crise sanitaire et les restrictions
en vigueur.&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2024-07-30-frise-chronologique.png" alt="Frise chronologiques des Meetup">&lt;/p>
&lt;p>Une pause de deux années supplémentaires s&amp;rsquo;est imposée au groupe, avant que ne se stabilise la situation sanitaire.
En 2022, j&amp;rsquo;ai ainsi contacté Lætitia Avrot, une membre très active de la communauté française, pour relancer les
activités et retrouver une dynamique et un rythme pour ses membres. L&amp;rsquo;événement du &lt;a href="https://www.meetup.com/meetup-postgresql-lille/events/284819405/" target="_blank" rel="noopener">14 avril 2022&lt;/a> fut un
soulagement pour moi, voyant que je pouvais toujours compter sur la participation de la communauté.&lt;/p>
&lt;p>À partir de cet instant, aucune nouvelle ombre n&amp;rsquo;est venue assombrir le tableau, et le groupe a pu reprendre
l&amp;rsquo;organisation régulière de rencontres, de deux à trois par ans. La communauté s&amp;rsquo;est élargie, et le comité
d&amp;rsquo;organisation s&amp;rsquo;est renforcé avec l&amp;rsquo;arrivée de Yoann La Cancellera en 2023, qui a permis notamment de déposer
une demande de reconnaissance au sein de la communauté internationale, le 24 février 2023.&lt;/p>
&lt;hr>
&lt;h2 id="how-to-meetup">How-to Meetup&lt;/h2>
&lt;p>En guise de conclusion à ce retour d&amp;rsquo;expérience, j&amp;rsquo;ai voulu partager toutes les étapes nécessaires pour
organiser un Meetup, en appuyant sur les points cruciaux de réussites et les pièges à éviter.&lt;/p>
&lt;p>&lt;strong>Accueil&lt;/strong> : trouver le lieu d&amp;rsquo;accueil de pour l&amp;rsquo;événement&lt;/p>
&lt;p>À l&amp;rsquo;image du PG Day France qui change de lieu chaque année, le groupe Meetup PG Lille a fait le
choix de varier les lieux d&amp;rsquo;accueil à chaque rencontre. Cela permet de découvrir de nouveaux espaces
et de stimuler la curiosité inter-communauté. Les entreprises locales sont souvent ravies de pouvoir
accueillir des événements techniques, et cela permet de renforcer les liens entre les acteurs locaux.&lt;/p>
&lt;p>La recherche d&amp;rsquo;un lieu est souvent la première étape de l&amp;rsquo;organisation d&amp;rsquo;un Meetup. Il est important
de trouver un espace qui puisse accueillir entre dix et quarante personnes, avec un accès en transports
en commun ou un parking à proximité. Pour cela, j&amp;rsquo;ai eu l&amp;rsquo;occasion d&amp;rsquo;user de plusieurs stratégies :&lt;/p>
&lt;ul>
&lt;li>Le bouche-à-oreille : demander à ses contacts professionnels s&amp;rsquo;ils connaissent des lieux d&amp;rsquo;accueil
potentiels&lt;/li>
&lt;li>Les réseaux sociaux : publier une annonce sur Twitter ou LinkedIn pour solliciter des propositions
spontanées ou des pistes à étudier&lt;/li>
&lt;li>La privatisation d&amp;rsquo;un espace : contacter les espaces de coworking ou les salles de réunion pour
obtenir un devis de location&lt;/li>
&lt;li>S&amp;rsquo;allier avec d&amp;rsquo;autres groupes : proposer un partenariat avec un autre groupe Meetup pour partager
les frais de location ou pour bénéficier d&amp;rsquo;un lieu d&amp;rsquo;accueil déjà identifié&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Intervenant·es&lt;/strong> : trouver &lt;u>deux&lt;/u> présentations variées&lt;/p>
&lt;p>Dès le premier Meetup, Pierre et Guillaume ont fait le choix de proposer deux présentations techniques
pour varier les sujets et les formats. Cela permet de toucher un public plus large et de satisfaire
les attentes des membres du groupe. Cette formule a été reprise pour les rencontres suivantes, et a
été un succès à chaque fois.&lt;/p>
&lt;p>La recherche d&amp;rsquo;intervenant·es est un travail qui demande du temps et de la patience. Souvent, une
rencontre opportune ou une discussion informelle peut déboucher sur une proposition de présentation.
Le mieux est de se constituer un vivier de personnes ressources, qui pourront être sollicitées en cas
de besoin. Ce n&amp;rsquo;est pas toujours facile, c&amp;rsquo;est un travail de longue haleine, mais cela en vaut la peine.&lt;/p>
&lt;p>Discutez autours de vous, demandez à vos collègues, à vos amis, à vos contacts professionnels s&amp;rsquo;ils
ne sont pas intéressés pour partager leur expérience ou leur expertise, ou s&amp;rsquo;ils ne connaissent pas
quelqu&amp;rsquo;un qui pourrait être intéressé.&lt;/p>
&lt;p>&lt;strong>Apéro&lt;/strong> : prolonger la soirée avec un temps fort communautaire (&lt;em>networking&lt;/em>)&lt;/p>
&lt;p>Selon moi, c&amp;rsquo;est l&amp;rsquo;étape &lt;strong>la plus importante&lt;/strong> de l&amp;rsquo;organisation d&amp;rsquo;un Meetup. (rires !)&lt;/p>
&lt;p>C&amp;rsquo;est le moment où les membres du groupe peuvent échanger, discuter, partager, et se rencontrer. C&amp;rsquo;est
un temps fort de la soirée qui me tient particulièrement à cœur, et qui est intimement lié à la réussite
de l&amp;rsquo;événement. Le &lt;em>networking&lt;/em> est ce qui favorise le mieux la sérendipité, la rencontre fortuite, le
partage d&amp;rsquo;expérience, et la création de liens durables. Je discute des prochains projets du groupe avec
les membres et le comité d&amp;rsquo;organisation, et je prends des notes sur les attentes de chacun·es et j&amp;rsquo;écoute
leurs suggestions.&lt;/p>
&lt;p>Bien entendu, il est important de prévoir des boissons et des encas pour prolonger la soirée. Il faut
prévoir un espace pour faciliter la circulation et la création naturelle de petits groupes de discussion.
Le choix d&amp;rsquo;un sponsor est principalement motivé par la prise en charge de ces frais, avec une facture ou
une note de frais à l&amp;rsquo;appui.&lt;/p>
&lt;p>Jusqu&amp;rsquo;à présent, aucun incident n&amp;rsquo;est à déplorer, les participants et participantes respectent les quelques
règles de sécurité et de conduite que l&amp;rsquo;on énonce en début de soirée.&lt;/p>
&lt;p>&lt;strong>Communication&lt;/strong> : atteindre la jauge d&amp;rsquo;inscription&lt;/p>
&lt;p>Cette étape est à prendre au sérieux un mois avant la tenue de l&amp;rsquo;événement. Il s&amp;rsquo;agit de maximiser la
visibilité de l&amp;rsquo;événement pour atteindre la jauge maximale établie par le lieu qui accueille l&amp;rsquo;événement.
Pour cela, j&amp;rsquo;ai eu l&amp;rsquo;occasion de me doter de plusieurs méthodes :&lt;/p>
&lt;ul>
&lt;li>Être le plus exhaustif possible dans la description de l&amp;rsquo;événement (date, lieu, horaires, programme,
sponsors, visuels, etc.)&lt;/li>
&lt;li>Créer du contenu régulier sur les réseaux sociaux pour rappeler la date de l&amp;rsquo;événement et les modalités
d&amp;rsquo;inscription (LinkedIn majoritaire, Twitter par le passé)&lt;/li>
&lt;li>Solliciter les participants de l&amp;rsquo;événement pour qu&amp;rsquo;ils partagent l&amp;rsquo;événement sur leurs réseaux sociaux ou
leurs réseaux d&amp;rsquo;entreprise&lt;/li>
&lt;li>Informer la communauté française avec la liste de diffusion &lt;code>pgsql-fr-generale&lt;/code> pour toucher un public plus
large, voire donner envie à d&amp;rsquo;autres groupes de se lancer dans l&amp;rsquo;organisation de Meetup (qui sait ?)&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Identité visuelle&lt;/strong> (optionnelle)&lt;/p>
&lt;p>Au cours des derniers mois, nous avons travaillé avec Yoann, la refonte de l&amp;rsquo;identité visuelle du groupe Meetup
avec un nouveau logo et une nouvelle charte graphique. C&amp;rsquo;est cosmétique, mais cela permet de donner une image
plus professionnelle et une identité forte au sein des communautés lilloises existantes. Nous espérons nous
faire une petite place et une petite notoriété dans le paysage local.&lt;/p>
&lt;p>Pour avoir délégué par deux fois la création de la vignette de l&amp;rsquo;événement, je recommande de travailler avec
un graphiste ou un designer pour obtenir un résultat professionnel et soigné. En attendant qu&amp;rsquo;un des membres
qui m&amp;rsquo;entoure soit suffisamment qualifié, on fait avec les moyens du bord.&lt;/p>
&lt;p>Enfin, et c&amp;rsquo;était notre petite fierté de l&amp;rsquo;année, nous nous sommes dotées d&amp;rsquo;un logo Slonik, la mascotte de
PostgreSQL. La démarche de création s&amp;rsquo;est appuyée énormément sur les nouveaux outils de génération par intelligences
artificielles, et nous avons été bluffés par la qualité du résultat. Un grand merci à &lt;a href="https://www.instagram.com/_ekpyrosis/" target="_blank" rel="noopener">Isaac&lt;/a>
pour son aide précieuse dans les retouches et les ajustements du logo.&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2024-07-30-logo-meetup-pg-lille.png" alt="Logo du groupe Meetup PG Lille">&lt;/p>
&lt;hr>
&lt;h2 id="remerciements">Remerciements&lt;/h2>
&lt;p>Au cours de cette conférence, j&amp;rsquo;ai eu l&amp;rsquo;occasion de remercier un tas de monde. En particulier, les membres de
l&amp;rsquo;association PostgreSQL France, pour leur confiance qu&amp;rsquo;ils nous ont accordée, Matthieu Cornillon et moi-même,
d&amp;rsquo;avoir accepté notre dossier de candidature pour le choix de la ville de Lille cette année 2024.&lt;/p>
&lt;p>Un des slides de ma présentation était dédié à toutes les entreprises qui ont accueilli nos rencontres,
et qui, sans le savoir, m&amp;rsquo;ont permis d&amp;rsquo;ajuster le format et le contenu de nos Meetups. Un grand merci à elles
pour leur sympathie et leur accueil chaleureux. C&amp;rsquo;était également l&amp;rsquo;opportunité de mettre en avant les intervenants
et les intervenantes qui ont accepté de partager leur expérience et leur expertise lors des Meetup PostgreSQL Lille.
Un grand merci à elles et à eux d&amp;rsquo;avoir vécu l&amp;rsquo;aventure avec moi !&lt;/p>
&lt;p>Enfin, j&amp;rsquo;ai été heureux que ce retour d&amp;rsquo;expérience puisse faire écho à quelques personnes dans la salle, qui
m&amp;rsquo;ont félicité pour le travail accompli et m&amp;rsquo;ont informé de leur intention de se lancer dans l&amp;rsquo;organisation
de Meetup dans leur propre ville. C&amp;rsquo;est une belle récompense pour moi, et cela me donne envie de poursuivre
mon engagement et de donner l&amp;rsquo;exemple pour la promotion de PostgreSQL en France.&lt;/p></description></item><item><title>Construire PostgreSQL avec Meson</title><link>https://fljd.in/2022/09/29/construire-postgresql-avec-meson/</link><pubDate>Thu, 29 Sep 2022 00:00:00 +0000</pubDate><author>Florent Jardin</author><guid>https://fljd.in/2022/09/29/construire-postgresql-avec-meson/</guid><description>&lt;p>Alors que la version 15 de PostgreSQL se prépare à sortir dans les &lt;a href="https://www.postgresql.org/about/news/postgresql-15-rc-1-released-2516/" target="_blank" rel="noopener">prochains
jours&lt;/a>, le groupe de développement du projet communautaire ont intégré &lt;a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=e6927270cd18d535b77cbe79c55c6584351524be" target="_blank" rel="noopener">leurs
récents travaux&lt;/a> pour accélérer les tâches d&amp;rsquo;automatisation et de compilation
à l&amp;rsquo;aide du système de construction &lt;a href="https://mesonbuild.com/" target="_blank" rel="noopener">Meson&lt;/a>.&lt;/p>
&lt;p>Ce chantier n&amp;rsquo;est pas anodin et redessine les contours de l&amp;rsquo;écosystème du moteur
de bases de données open-source le plus avancé au monde. Depuis sa forme libre
publiée en 1998, PostgreSQL repose sur des solutions robustes et éprouvées, mais
de plus en plus complexes à maintenir pour les nouvelles générations de
contributeur·rices. En proposant de se tourner vers un logiciel comme Meson, ces
amoureux et amoureuses du libre se tournent résolument vers l&amp;rsquo;avenir.&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2022-09-29-andres-freund-e692323.png" alt="patch">&lt;/p>
&lt;hr>
&lt;h2 id="en-finir-avec-autoconf">En finir avec autoconf&lt;/h2>
&lt;p>Un système de construction ou &lt;em>build system&lt;/em> (ne vous y trompez pas, j&amp;rsquo;ai une
préférence pour la dénomination anglaise) est un ensemble d&amp;rsquo;instructions dans
une syntaxe qui lui est propre, qui facilite la compilation d&amp;rsquo;un logiciel. Les
ramifications d&amp;rsquo;un projet, les dépendances et les librairies ou tout simplement
l&amp;rsquo;outillage interne, deviennent inexorablement la rançon d&amp;rsquo;une complexité après
plusieurs décennies d&amp;rsquo;existence.&lt;/p>
&lt;p>Le système le plus répandu est sans conteste &lt;a href="https://en.wikipedia.org/wiki/Make_%28software%29" target="_blank" rel="noopener">Make&lt;/a> et son fichier déclaratif
&lt;em>Makefile&lt;/em> qui contiendra les instructions de compilation. Son principe absolu
consiste à transformer un fichier source (le code) en un autre fichier cible (le
binaire). Dans un projet minimaliste, le &lt;em>Makefile&lt;/em> suivant permet de générer le
binaire &lt;code>foo&lt;/code> si le code source &lt;code>foo.c&lt;/code> ou son en-tête &lt;code>foo.h&lt;/code> contiennent des
nouveautés.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-make" data-lang="make">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ./Makefile
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">&lt;/span>&lt;span class="nv">CC&lt;/span>&lt;span class="o">=&lt;/span>gcc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CFLAGS&lt;/span>&lt;span class="o">=&lt;/span>-I.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">foo&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">foo&lt;/span>.&lt;span class="n">c&lt;/span> &lt;span class="n">foo&lt;/span>.&lt;span class="n">h&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">$(&lt;/span>CC&lt;span class="k">)&lt;/span> -o foo foo.c
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>À l&amp;rsquo;appel de la commande &lt;code>make&lt;/code> à la racine du projet, le fichier &lt;em>Makefile&lt;/em>
sera parcouru pour détecter les cibles du projet et suivre les instructions
selon les règles qui y sont renseignées pour construire les fichiers binaires.&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2022-09-29-makefile-workflow.png" alt="Compilation par Makefile">&lt;/p>
&lt;p>Une &lt;a href="https://en.wikipedia.org/wiki/List_of_build_automation_software#Build_script_generation" target="_blank" rel="noopener">pratique plus sophistiquée&lt;/a> propose de générer ces instructions dans un
format compatible avec le système de construction, lorsque celles-ci sont
nombreuses, évolutives voire dépendantes d&amp;rsquo;un contexte ou d&amp;rsquo;un environnement tel
que le système d&amp;rsquo;exploitation ou l&amp;rsquo;utilisation d&amp;rsquo;une option spécifique.&lt;/p>
&lt;p>Dans le cas du projet PostgreSQL, c&amp;rsquo;est la suite &lt;a href="https://en.wikipedia.org/wiki/GNU_Autotools" target="_blank" rel="noopener">GNU Autotools&lt;/a> qui a été
partiellement retenue pour faciliter la création des binaires sur un ensemble de
systèmes compatibles Unix. La génération repose sur les composants &lt;em>Autoconf&lt;/em>
(fichier &lt;code>configure.ac&lt;/code>) et &lt;em>Automake&lt;/em> (fichier &lt;code>Makefile.am&lt;/code>) pour aboutir au
même résultat que la commande &lt;code>make&lt;/code> de notre précédent exemple. Dans les faits,
seul le premier composant est véritablement employé pour préparer le script
&lt;code>configure&lt;/code> lors de la compilation de PostgreSQL.&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2022-09-29-autotools-workflow.png" alt="Génération avec Autotools">&lt;/p>
&lt;p>Comme le montre le diagramme ci-dessus, les étapes avant d&amp;rsquo;obtenir le fichier
binaire sont un peu plus nombreuses, et dépendent d&amp;rsquo;un ensemble de fichiers
d&amp;rsquo;instructions qui deviennent complexes à rédiger sans introduire d&amp;rsquo;incohérences
ou de bogues.&lt;/p>
&lt;p>C&amp;rsquo;est d&amp;rsquo;ailleurs l&amp;rsquo;un des constats de la communauté qui, depuis fin 2021, a
questionné la possibilité de passer sur un autre système de construction.&lt;/p>
&lt;blockquote>
&lt;p>Autoconf is showing its age, fewer and fewer contributors know how to wrangle
it. Recursive make has a lot of hard to resolve dependency issues and slow
incremental rebuilds.&lt;/p>&lt;/blockquote>
&lt;p>Le principal moteur de la réflexion, Andres Freund, annonçait dans un
&lt;a href="https://www.postgresql.org/message-id/20211012083721.hvixq4pnh2pixr3j%40alap3.anarazel.de" target="_blank" rel="noopener">message&lt;/a> sur &lt;em>pgsql-hackers&lt;/em> qu&amp;rsquo;il observait de bien meilleures performances
avec une alternative bien plus moderne. Il y énonçait par ailleurs ses arguments
pour en finir avec &lt;em>Autoconf&lt;/em> :&lt;/p>
&lt;ul>
&lt;li>
&lt;p>« &lt;em>Autoconf&lt;/em> et &lt;em>make&lt;/em> ne sont plus activement maintenus. Notamment &lt;em>autoconf&lt;/em>
qui reçoit à peine quelques correctifs mineurs. C&amp;rsquo;est également des
technologies que peu de monde veut utiliser &amp;ndash; m4 d&amp;rsquo;autoconf est effrayant et
effraie les personnes qui démarrent bien plus récemment que nous autres, les
&lt;em>committers&lt;/em> » ;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>« &lt;em>make&lt;/em> en mode récursif comme nous l&amp;rsquo;utilisons n&amp;rsquo;est pas aussi bien employé
que ce qu&amp;rsquo;il devrait être. L&amp;rsquo;une des raisons pour laquelle le nettoyage du
&lt;em>build&lt;/em> est si lent est que nous devons retrouver les dépendances dans un
paquet d&amp;rsquo;endroits. En malgré cela, il m&amp;rsquo;arrive régulièrement de voir des
&lt;em>builds&lt;/em> incrémentaux échouer et nécessitant un nouveau &lt;em>rebuild&lt;/em> » ;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>« Et nous n&amp;rsquo;avons pas uniquement un système de &lt;em>build&lt;/em> basé sur &lt;em>autoconf&lt;/em> et
&lt;em>make&lt;/em>, il y a surtout le projet de génération MSVC (&lt;em>Microsoft Visual C++&lt;/em>)
&amp;ndash; ce machin que la plupart d&amp;rsquo;entre nous ne veut pas toucher. Je pense qu&amp;rsquo;en
plus du fait qu&amp;rsquo;il n&amp;rsquo;y est pas facile de dérouler tous les tests, ce système
est juste tout simplement différent de l&amp;rsquo;autre, ce qui ne favorise pas l&amp;rsquo;intérêt
des développeurs sous Windows (et indirectement, la qualité de PostgreSQL sur
Windows) » ;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>« Le dernier gros problème que je vois avec la situation actuelle est qu&amp;rsquo;il
n&amp;rsquo;y a aucun bon test d&amp;rsquo;intégration. Le résultat de &lt;code>make check-world&lt;/code> est très
majoritairement illisible et impossible à analyser automatiquement. Ce qui
impose à la &lt;em>&lt;a href="https://buildfarm.postgresql.org/cgi-bin/show_status.pl" target="_blank" rel="noopener">buildfarm&lt;/a>&lt;/em> de traiter les tests séparément afin que les
erreurs puissent être repérées et tracées correctement. Cette approche n&amp;rsquo;est
malheureusement pas adaptée aux processeurs multicœurs et ralentit considérablement
l&amp;rsquo;ensemble des serveurs ».&lt;/p>
&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="meson-une-alternative-moderne">Meson, une alternative moderne&lt;/h2>
&lt;p>À l&amp;rsquo;image des &lt;em>Autotools&lt;/em>, &lt;a href="https://mesonbuild.com/" target="_blank" rel="noopener">Meson&lt;/a> est un système qui génère les instructions
de compilation. Ce fut le choix qu&amp;rsquo;a proposé Andres Freund à la communauté après
l&amp;rsquo;avoir analysé aux côtés de &lt;a href="https://cmake.org/cmake/help/book/mastering-cmake/chapter/Why%20CMake.html#" target="_blank" rel="noopener">CMake&lt;/a> et &lt;a href="https://bazel.build/about/vision" target="_blank" rel="noopener">Bazel&lt;/a>, deux autres compétiteurs
bien connus du monde libre. Meson est écrit en Python et son but premier est de
réduire la part d&amp;rsquo;efforts des développeurs dans la rédaction d&amp;rsquo;instructions au
profit d&amp;rsquo;une plus grande productivité sur le logiciel en tant que tel.&lt;/p>
&lt;p>Le projet Meson s&amp;rsquo;appuie sur un système de construction bas niveau appelé
&lt;a href="https://ninja-build.org/" target="_blank" rel="noopener">ninja&lt;/a> qui se veut, d&amp;rsquo;après son auteur &lt;a href="https://neugierig.org/software/chromium/notes/2011/02/ninja.html" target="_blank" rel="noopener">Evan Martin&lt;/a>, être minimaliste
et bien plus performant que &lt;code>make&lt;/code>. Les instructions de compilation sont
renseignées automatiquement par Meson dans le fichier &lt;code>build.ninja&lt;/code> qui sera
ensuite parcouru par la commande &lt;code>ninja&lt;/code> pour compiler les sources en un fichier
binaire.&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2022-09-29-meson-workflow.png" alt="Génération avec Meson">&lt;/p>
&lt;p>Pour reprendre mon projet minimaliste &lt;code>foo&lt;/code>, le fichier &lt;em>Makefile&lt;/em> est remplacé
par le fichier &lt;code>meson.build&lt;/code>, en y renseignant les méta-données du projet, le
point d&amp;rsquo;entrée du programme et le fichier binaire souhaité.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rb" data-lang="rb">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ./meson.build&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">project&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;foo&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;c&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">executable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;foo&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;foo.c&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Meson est un jeune projet, dont la première sortie date de 2013. Bien qu&amp;rsquo;il
rougît de son âge face à CMake, il n&amp;rsquo;en reste pas moins un concurrent qui ne
cesse de &lt;a href="https://gms.tf/the-rise-of-meson.html" target="_blank" rel="noopener">gagner du terrain&lt;/a> depuis la dernière décennie. Parmi les
&lt;a href="https://mesonbuild.com/Users.html" target="_blank" rel="noopener">projets&lt;/a> qui s&amp;rsquo;appuient désormais sur Meson, je peux citer de très connus
comme : &lt;code>systemd&lt;/code>, Gnome et GTK+, QEMU, Xorg et Wayland&amp;hellip; De quoi se parer
d&amp;rsquo;une forte communauté d&amp;rsquo;utilisateurs dans les prochaines années !&lt;/p>
&lt;p>Sur la page « &lt;a href="https://mesonbuild.com/Use-of-Python.html" target="_blank" rel="noopener">Use of Python&lt;/a> » du projet, les créateurs de Meson se
défendent d&amp;rsquo;un reproche souvent adressé aux technologies modernes et affirment
ne reposer que sur &lt;code>python3&lt;/code> tout en interdisant l&amp;rsquo;usage de modules externes,
en gages de qualité et de compatibilité. Ainsi, le projet se veut accessible
pour tous les systèmes d&amp;rsquo;exploitation, faisait un pied de nez au mastodonte
&lt;em>Autotools&lt;/em> qui était très couplé au &lt;em>shell&lt;/em> Unix dans son implémentation.&lt;/p>
&lt;p>La décision pour le projet PostgreSQL de progressivement glisser vers Meson est
le fruit de plusieurs mois de réflexion, avec pour ambition notamment de se
passer du système &lt;a href="https://github.com/postgres/postgres/tree/master/src/tools/msvc" target="_blank" rel="noopener">MSVC&lt;/a>, un ensemble de scripts Perl maison maintenus par
une poignée de personnes pour compiler le logiciel sous Windows. En prime, les
travaux d&amp;rsquo;Andres démontrent un gain significatif dans les temps de &lt;em>build&lt;/em>, ce
qui ne paraît pas surprenant au regard du &lt;em>&lt;a href="https://mesonbuild.com/ARM-performance-test.html" target="_blank" rel="noopener">benchmark&lt;/a>&lt;/em> entre les deux
systèmes sur une architecture ARM.&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2022-09-29-meson-autotools-benchmark-conf.png" alt="Benchmark sur le temps de configuration">&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2022-09-29-meson-autotools-benchmark-build.png" alt="Benchmark sur le temps de configuration">&lt;/p>
&lt;blockquote>
&lt;p>In any case, using Autotools for a modern C/C++ project in 2021 is like using
CVS for source code version control in 2021: there are better tools available
and thus it isn&amp;rsquo;t very interesting to still consider the legacy solutions.&lt;/p>
&lt;p>&lt;em>Citation de &lt;a href="https://gms.tf/the-rise-of-meson.html" target="_blank" rel="noopener">Georg Sauthoff, The Rise of Meson&lt;/a>.&lt;/em>&lt;/p>&lt;/blockquote>
&lt;hr>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>La route empruntée semble la bonne, bien que le chemin soit encore long pour se
débarrasser définitivement des résidus historiques d&amp;rsquo;&lt;em>Autoconf&lt;/em> dans le projet
PostgreSQL. Lors de la dernière &lt;em>&lt;a href="https://wiki.postgresql.org/wiki/PgCon_2022_Developer_Unconference#Meson_new_build_system_proposal" target="_blank" rel="noopener">Developer Unconference&lt;/a>&lt;/em> qui s&amp;rsquo;est tenue
en ligne le 25 mai 2022 lors de l&amp;rsquo;événement annuel du PgCon, les membres de la
communauté ont statué sur les efforts à fournir pour porter ce chantier
titanesque.&lt;/p>
&lt;p>Avec ce récent &lt;a href="https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=e6927270cd18d535b77cbe79c55c6584351524be" target="_blank" rel="noopener">patch&lt;/a> rattaché à présent à la branche &lt;em>master&lt;/em>, la
construction des binaires sur la plupart des systèmes d&amp;rsquo;exploitation est
implémentée, avec notamment la compilation de PostgreSQL sur Windows à travers
&lt;code>ninja&lt;/code>. C&amp;rsquo;est une première pierre qui est posée pour la prochaine version 16 en
cours de développement et l&amp;rsquo;émergence d&amp;rsquo;une architecture qui grandira avec
d&amp;rsquo;autres améliorations dans un avenir proche.&lt;/p></description></item><item><title>Migrer vers PostgreSQL</title><link>https://fljd.in/2021/12/06/migrer-vers-postgresql/</link><pubDate>Mon, 06 Dec 2021 00:00:00 +0000</pubDate><author>Florent Jardin</author><guid>https://fljd.in/2021/12/06/migrer-vers-postgresql/</guid><description>&lt;p>Le marché de la migration en France est intense. Le Groupe de Travail
Inter-Entreprises PostgreSQL (PGGTIE) a même publié un &lt;a href="https://www.postgresql.fr/_media/entreprises/guide-de-transition_v2.0.pdf" target="_blank" rel="noopener">guide de transition&lt;/a>
à PostgreSQL à destination des entreprises françaises. Ce dernier est le fruit
de près de cinq années de travaux au sein de plusieurs organismes publics et a
pour ambition de démontrer l&amp;rsquo;intérêt de PostgreSQL aux décideurs techniques en
présentant les forces et les faiblesses du moteur.&lt;/p>
&lt;p>Le mois dernier, une traduction en anglais est &lt;a href="https://twitter.com/nthonynowocien/status/1458065335387578382" target="_blank" rel="noopener">sortie des cartons&lt;/a> pour
promouvoir davantage ce mouvement vers le logiciel libre dans les autres pays.
Je trouvais intéressant de profiter de cette actualité pour partager mes
réflexions du moment, entre ma vision du marché français et l&amp;rsquo;approche technique
pour engager les migrations de données vers PostgreSQL.&lt;/p>
&lt;hr>
&lt;h2 id="une-transition-à-marche-forcée">Une transition à marche forcée&lt;/h2>
&lt;p>La démarche n&amp;rsquo;est pas anodine, car depuis 2012, l&amp;rsquo;État français au travers de ses
différents ministères, tente de contrer l&amp;rsquo;imposant marché des logiciels
propriétaires en favorisant leurs remplacements systématiques par une alternative
Open Source. Depuis quelques années, le &lt;a href="https://www.numerique.gouv.fr/actualites/socle-interministeriel-des-logiciels-libres-sill-2020/" target="_blank" rel="noopener">Socle Interministériel de Logiciels Libres&lt;/a>
(SILL) est mis à jour par un groupe de travail pour faire un bilan des choix
structurants engagés sur le territoire français.&lt;/p>
&lt;p>La publication d&amp;rsquo;un guide de transition pour PostgreSQL aspire à rassurer les
équipes opérationnelles et décisionnelles en apportant un grand nombre de conseils
et de comparaisons sur ce qu&amp;rsquo;il est aujourd&amp;rsquo;hui possible de faire avec PostgreSQL.
Il mentionne les trois grandes étapes pour réaliser la migration des données
d&amp;rsquo;une application vers le moteur open-source :&lt;/p>
&lt;ul>
&lt;li>migration des données ;&lt;/li>
&lt;li>correction et réécriture des requêtes SQL et des procédures embarquées ;&lt;/li>
&lt;li>recette du système pour écarter les régressions fonctionnelles.&lt;/li>
&lt;/ul>
&lt;p>Chacune de ces étapes a un coût, qu&amp;rsquo;il sera nécessaire de pondérer durant le
chantier de migration. Les logiciels Open Source sont libres, mais ne sont pas
gratuits et c&amp;rsquo;est un rappel essentiel que proposent les conclusions de ce guide.
Les coûts de formation et de prestations externes ne sont également pas
négligeables…&lt;/p>
&lt;p>En 2018, la société française &lt;a href="https://dalibo.com" target="_blank" rel="noopener">Dalibo&lt;/a> avait publié un
&lt;a href="https://public.dalibo.com/archives/marketing/livres_blancs/18.10/DLB01_Migrer_Oracle_Postgresql.pdf" target="_blank" rel="noopener">livre blanc&lt;/a> dans ce même esprit de pédagogie sur l&amp;rsquo;importance des coûts
d&amp;rsquo;investissement et de possession. Dans un scénario de migration, acté sur cinq
années de transition, l&amp;rsquo;étude montre que l&amp;rsquo;analyse de portabilité vers PostgreSQL
est la principale dépense au cours de la première année, suivie par un
investissement important pour la recherche et le développement d&amp;rsquo;un socle d&amp;rsquo;outils
dédiés aux déploiements, la maintenance et l&amp;rsquo;administration du parc PostgreSQL.&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2021-12-06-cout-d-investissement.png" alt="Plan d’investissement">&lt;/p>
&lt;p>&lt;img src="https://fljd.in/img/fr/2021-12-06-cout-de-possession.png" alt="Plan de possession">&lt;/p>
&lt;p>La seconde courbe peut paraître surprenante pour du logiciel libre, mais la
nécessité de contracter une offre de support reste d&amp;rsquo;actualité, car trop peu de
services informatiques disposent des compétences internes pour assurer la
disponibilité et la maintenance des instances. Un effort initial de formation est
requis pour aider les administrateurs en poste à faire également leur transition
vers cette autre technologie.&lt;/p>
&lt;p>Pour cette raison, de nombreux acteurs se positionnent depuis des décennies pour
proposer de l&amp;rsquo;accompagnement opérationnel et technique auprès des entreprises
de toutes tailles qui souhaitent (principalement) réduire les coûts de licence
de logiciels propriétaires. Et bien que la transition pouvait être pénible il y
a dix ans, les dernières versions de PostgreSQL et la prolifération d&amp;rsquo;outils
communautaires apportent leur lot de fonctionnalités qui ne rougissent plus
devant les atouts phares de certains mastodontes historiques du marché.&lt;/p>
&lt;hr>
&lt;h2 id="sarmer-doutils-et-de-courage">S&amp;rsquo;armer d&amp;rsquo;outils et de courage&lt;/h2>
&lt;p>Réaliser une migration impose de s&amp;rsquo;équiper d&amp;rsquo;un panel d&amp;rsquo;outils pour simplifier
les grandes lignes de la migration et bien sûr, économiser du temps et de l&amp;rsquo;argent.
Parmi les contributions libres, nous retrouverons l&amp;rsquo;incontournable &lt;a href="https://ora2pg.darold.net/" target="_blank" rel="noopener">Ora2pg&lt;/a>,
spécialisé dans la conversion d&amp;rsquo;un schéma Oracle et la migration de son contenu
vers une instance PostgreSQL. Pour une base de type SQL Server de Microsoft,
&lt;a href="https://pgloader.io/" target="_blank" rel="noopener">pgloader&lt;/a> sera privilégié. Les deux outils supportent également les données
en provenance de MySQL.&lt;/p>
&lt;p>En &lt;a href="https://fljd.in/2021/07/16/parlons-un-peu-des-donnees-externes/">juillet dernier&lt;/a>, je partageais mes réflexions sur l&amp;rsquo;implémentation de la
norme SQL/MED et des &lt;em>foreign data wrappers&lt;/em>, ou connecteurs. L&amp;rsquo;actualité fut
particulièrement riche cet été, avec la sortie de la &lt;a href="https://www.migops.com/blog/2021/07/01/ora2pg-now-supports-oracle_fdw-to-increase-the-data-migration-speed/" target="_blank" rel="noopener">version 22.0&lt;/a> du projet
Ora2Pg, dont le nouveau support de l&amp;rsquo;extension &lt;code>oracle_fdw&lt;/code> annonçait des gains
vertigineux sur le temps de copie des données.&lt;/p>
&lt;p>Ni une ni deux, j&amp;rsquo;ai souhaité comprendre et découvrir les dessous d&amp;rsquo;un tel
procédé en manipulant moi-même les tables externes pour réaliser une migration
de schémas et de données d&amp;rsquo;une base Oracle vers PostgreSQL, sans utiliser l&amp;rsquo;outil
Ora2Pg. Cette procédure s&amp;rsquo;inspire d&amp;rsquo;un &lt;a href="https://www.migops.com/blog/2021/02/15/role-of-foreign-data-wrappers-in-migrations-to-postgresql/" target="_blank" rel="noopener">autre article&lt;/a> de MigOps, publié plus
tôt cette année.&lt;/p>
&lt;h3 id="1-compiler-le-wrapper-communautaire">1. Compiler le wrapper communautaire&lt;/h3>
&lt;p>Le connecteur &lt;code>oracle_fdw&lt;/code> nécessite d&amp;rsquo;être compilé à partir des &lt;a href="https://github.com/laurenz/oracle_fdw/" target="_blank" rel="noopener">sources du projet&lt;/a>
pour prendre en compte les bibliothèques propriétaires d&amp;rsquo;Oracle, garantes du
protocole de connexion et des échanges de données. Dans l&amp;rsquo;exemple ci-dessous, je
dispose d&amp;rsquo;un serveur CentOS 7 avec une instance PostgreSQL 14 et j&amp;rsquo;ai installé
l&amp;rsquo;&lt;em>Instant Client&lt;/em> 19, &lt;a href="https://www.oracle.com/database/technologies/instant-client/downloads.html" target="_blank" rel="noopener">disponible&lt;/a> sur la plateforme de téléchargement d&amp;rsquo;Oracle.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">yum install -y postgresql14-devel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">ORACLE_HOME&lt;/span>&lt;span class="o">=&lt;/span>/usr/lib/oracle/19.13/client64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">LD_LIBRARY_PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$ORACLE_HOME&lt;/span>/lib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$PATH&lt;/span>:&lt;span class="nv">$ORACLE_HOME&lt;/span>/bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> ORACLE_FDW_2_4_0/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make &lt;span class="nv">PG_CONFIG&lt;/span>&lt;span class="o">=&lt;/span>/usr/pgsql-14/bin/pg_config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">make &lt;span class="nv">PG_CONFIG&lt;/span>&lt;span class="o">=&lt;/span>/usr/pgsql-14/bin/pg_config install
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Pour résoudre &lt;a href="https://github.com/laurenz/oracle_fdw/issues/312" target="_blank" rel="noopener">d&amp;rsquo;éventuels problèmes&lt;/a> de détection de la librairie Oracle
&lt;em>Instant Client&lt;/em> et permettre la création de l&amp;rsquo;extension, il est nécessaire de
renseigner la variable &lt;code>$LD_LIBRARY_PATH&lt;/code> pour l&amp;rsquo;instance PostgreSQL au niveau
de son service :&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">systemctl edit postgresql-14
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Service]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Environment&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;ORACLE_HOME=/usr/lib/oracle/19.13/client64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Environment&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;LD_LIBRARY_PATH=/usr/lib/oracle/19.13/client64/lib&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>L&amp;rsquo;extension peut ainsi être créée avec les privilèges d&amp;rsquo;un super-utilisateur
dans la base qui accueillera les données finales. Le privilège &lt;code>USAGE&lt;/code> peut ensuite
être octroyé au propriétaire de la base pour préparer le schéma.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">EXTENSION&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oracle_fdw&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GRANT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USAGE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DATA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WRAPPER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oracle_fdw&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hr&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="2-importer-les-tables-externes">2. Importer les tables externes&lt;/h3>
&lt;p>L&amp;rsquo;unique configuration repose sur la création d&amp;rsquo;un objet &lt;code>SERVER&lt;/code> et l&amp;rsquo;attribution
d&amp;rsquo;un mot de passe pour l&amp;rsquo;utilisateur courant, afin d&amp;rsquo;ouvrir un pont entre les
deux systèmes.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SERVER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">orcl_hr&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DATA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">WRAPPER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">oracle_fdw&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">OPTIONS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dbserver&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;//localhost:1521/hr&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MAPPING&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOR&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hr&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SERVER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">orcl_hr&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">OPTIONS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">user&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;hr&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">password&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;demo&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>La magie du &lt;em>wrapper&lt;/em> opère lors de l&amp;rsquo;inspection de la base de données externe
et de la création des relations dans un schéma PostgreSQL. Dans mon exemple, je
dispose d&amp;rsquo;une base Oracle XE avec le &lt;a href="https://github.com/oracle/db-sample-schemas/tree/master/human_resources" target="_blank" rel="noopener">schéma prédéfini HR&lt;/a> contenant une
variété de tables, de vues, d&amp;rsquo;index et de contraintes d&amp;rsquo;intégrité.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SCHEMA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">search_path&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">IMPORT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SCHEMA&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;HR&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SERVER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">orcl_hr&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Avec &lt;code>psql&lt;/code> et la méta-commande &lt;code>\dE&lt;/code>, il est dès lors possible de consulter les
tables externes importées dans le schéma &lt;code>source&lt;/code>. L&amp;rsquo;une des huit tables est en
réalité une vue, car l&amp;rsquo;extension consulte le catalogue &lt;code>ALL_TAB_COLUMNS&lt;/code> dans
lequel figurent les tables et vues accessibles par l&amp;rsquo;utilisateur connecté. Dans
la phase d&amp;rsquo;étude de la migration, ce point doit être correctement identifié pour
récupérer l&amp;rsquo;ordre de création de la vue, en adaptant la requête SQL si besoin.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl"> List of relations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Schema | Name | Type | Owner
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--------+------------------+---------------+-------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> source | countries | foreign table | hr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> source | departments | foreign table | hr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> source | emp_details_view | foreign table | hr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> source | employees | foreign table | hr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> source | job_history | foreign table | hr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> source | jobs | foreign table | hr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> source | locations | foreign table | hr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> source | regions | foreign table | hr
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="3-créer-les-tables-et-les-vues">3. Créer les tables et les vues&lt;/h3>
&lt;p>Pour chacune de ces tables externes, il faut créer leur équivalent dans la base
PostgreSQL. Pour mon exemple, je choisis le schéma &lt;code>public&lt;/code> comme destination.
L&amp;rsquo;une des méthodes les plus rapides repose sur l&amp;rsquo;option &lt;code>LIKE&lt;/code> de l&amp;rsquo;instruction
&lt;code>CREATE TABLE&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">countries&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">LIKE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">countries&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">departments&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">LIKE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">departments&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">employees&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">LIKE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">employees&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">job_history&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">LIKE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">job_history&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">jobs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">LIKE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">jobs&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">locations&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">LIKE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">locations&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">regions&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">LIKE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">regions&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>À partir de cette étape, il est judicieux d&amp;rsquo;apporter quelques modifications aux
types de colonnes. En effet, les types &lt;code>DATE&lt;/code> et &lt;code>NUMBER&lt;/code> en provenance d&amp;rsquo;Oracle
ont des équivalences bien plus riches et efficientes avec PostgreSQL. Pour aller
plus loin, l&amp;rsquo;un des chapitres de la formation Dalibo « &lt;a href="https://public.dalibo.com/exports/formation/manuels/modules/n3/n3.handout.html#types-de-donn%C3%A9es" target="_blank" rel="noopener">Migrer d’Oracle à
PostgreSQL&lt;/a> » revient sur les différences notables entre les deux systèmes.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">regions&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">region_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TYPE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">smallint&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">countries&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">region_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TYPE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">smallint&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">employees&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">hire_date&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TYPE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">date&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">job_history&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">start_date&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TYPE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">date&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">end_date&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TYPE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">date&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>La vue, quant à elle, doit être recréée pour les besoins de l&amp;rsquo;application.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">OR&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">REPLACE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">VIEW&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">emp_details_view&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">employee_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">job_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">manager_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">department_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">location_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">country_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">first_name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">last_name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">salary&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">commission_pct&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">department_name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">job_title&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">city&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">state_province&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">country_name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">region_name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">employee_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">job_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">manager_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">department_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">location_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">country_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">first_name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">last_name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">salary&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">commission_pct&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">department_name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">job_title&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">city&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">state_province&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">country_name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">region_name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">employees&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">departments&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">department_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">department_id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">jobs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">job_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">job_id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">locations&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">l&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">location_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">location_id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">countries&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">c&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">country_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">country_id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">regions&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">region_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">region_id&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="4-importer-les-données">4. Importer les données&lt;/h3>
&lt;p>La méthode la plus simple pour importer les données reste la copie table à table
avec l&amp;rsquo;instruction &lt;code>INSERT INTO&lt;/code>. Avec PostgreSQL, la commande &lt;code>TABLE&lt;/code> est
équivalente à un &lt;code>SELECT * FROM&lt;/code>, que j&amp;rsquo;utilise pour alléger les requêtes dans
l&amp;rsquo;exemple ci-dessous.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">countries&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">countries&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">departments&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">departments&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">employees&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">employees&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">job_history&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">job_history&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">jobs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">jobs&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">locations&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">locations&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">INSERT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INTO&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">public&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">regions&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">regions&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Dans le cas de tables hautement volumineuses, cette méthode montrera très vite
des faiblesses de performance, car les instructions sont exécutées les unes après
les autres et que le parcours d&amp;rsquo;une table distante n&amp;rsquo;est réalisé que par un seul
processus.&lt;/p>
&lt;p>À moins de développer son propre système de distribution de requêtes et de
lectures parallélisées, sachez que l&amp;rsquo;outil Ora2Pg propose parfaitement des pistes
d&amp;rsquo;optimisation pour accélérer grandement les insertions lors de cette phase de
chargement.&lt;/p>
&lt;h3 id="5-créer-les-séquences-les-index-et-les-contraintes">5. Créer les séquences, les index et les contraintes&lt;/h3>
&lt;p>Cette dernière étape est indispensable pour maintenir la cohérence du modèle et
pour garantir des performances similaires, il ne faut donc pas mésestimer la
phase d&amp;rsquo;étude qui permettra d&amp;rsquo;inventorier les séquences, les index et les
contraintes à recréer dans la base PostgreSQL. Pour aller jusqu&amp;rsquo;au bout de ma
démonstration, voici les instructions à exécuter pour finaliser la migration.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- regions
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">regions&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">reg_id_pk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">region_id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- countries
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">countries&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">country_c_id_pk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">country_id&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">countr_reg_fk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">region_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">regions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">region_id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- locations
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SEQUENCE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">locations_seq&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">START&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WITH&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">3300&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INCREMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">MAXVALUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">9900&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">locations&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">location_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nextval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;locations_seq&amp;#39;&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="n">regclass&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">loc_id_pk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">location_id&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">loc_c_id_fk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">country_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">countries&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">country_id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- departments
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SEQUENCE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">departments_seq&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">START&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WITH&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">280&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INCREMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">MAXVALUE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">9990&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">departments&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">department_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nextval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;departments_seq&amp;#39;&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="n">regclass&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dept_id_pk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">department_id&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dept_loc_fk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">location_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">locations&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">location_id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- jobs
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">jobs&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">job_id_pk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">job_id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- employees
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SEQUENCE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">employees_seq&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">START&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WITH&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">207&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INCREMENT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">employees&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">employee_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">nextval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;employees_seq&amp;#39;&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="n">regclass&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">emp_emp_id_pk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">employee_id&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">emp_dept_fk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">department_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">departments&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">emp_job_fk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">job_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">jobs&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">job_id&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">emp_manager_fk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">manager_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">employees&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">departments&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">dept_mgr_fk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">manager_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">employees&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">employee_id&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- job_history
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">ALTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">job_history&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">jhist_emp_id_st_date_pk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">employee_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">start_date&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">jhist_job_fk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">job_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">jobs&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">jhist_emp_fk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">employee_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">employees&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">ADD&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">CONSTRAINT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">jhist_dept_fk&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FOREIGN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">department_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">REFERENCES&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">departments&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Dans des situations particulièrement simples, la migration vers PostgreSQL peut
être intégralement réalisée à l&amp;rsquo;aide du langage SQL et d&amp;rsquo;une extension de la
famille des &lt;em>foreign data wrappers&lt;/em>. Cependant, le temps de copie restera très
dépendant de l&amp;rsquo;ordonnancement que l&amp;rsquo;on peut en faire, et du débit de transfert
entre les deux systèmes.&lt;/p>
&lt;hr>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>La migration deviendra complexe lorsque la base de données à migrer embarque du
code PL/SQL stratégique. À moins d&amp;rsquo;extraire la logique métier et de l&amp;rsquo;implémenter
dans une application dédiée, la conversion du code en routines PL/pgSQL méritera
toute votre attention. Bien qu&amp;rsquo;Ora2Pg puisse simplifier le travail de portage
avec une conversion automatique tout à fait honorable, il sera indispensable de
tester la non-régression fonctionnelle.&lt;/p>
&lt;p>Un outil comme &lt;a href="https://fljd.in/2020/05/14/ecrire-ses-tests-unitaires-en-sql/">pgTAP&lt;/a> peut aider à rédiger des tests unitaires ou de bout
en bout pour couvrir le code et vous accompagner dans le portage des procédures.
L&amp;rsquo;année dernière, j&amp;rsquo;avais pris plaisir à rédiger un &lt;a href="https://blog.dalibo.com/2020/12/21/migration_oracle_vers_postgresql.html" target="_blank" rel="noopener">atelier complet&lt;/a> sur la
traduction des procédures PL/SQL fournies avec le schéma HR présenté aujourd&amp;rsquo;hui.
N&amp;rsquo;hésitez pas à le consulter !&lt;/p></description></item><item><title>BorgBackup ou la sauvegarde facile</title><link>https://fljd.in/2021/08/24/borg-ou-la-sauvegarde-facile/</link><pubDate>Tue, 24 Aug 2021 00:00:00 +0000</pubDate><author>Florent Jardin</author><guid>https://fljd.in/2021/08/24/borg-ou-la-sauvegarde-facile/</guid><description>&lt;p>Jusqu&amp;rsquo;à très récemment, je ne me préoccupais pas de la pertinence de mes
sauvegardes de fichiers personnels réalisées naïvement avec un script &lt;code>rsync&lt;/code>.
C&amp;rsquo;est honteux dans nos métiers, mais l&amp;rsquo;adage du cordonnier s&amp;rsquo;est vérifié avec
moi lors de l&amp;rsquo;exécution d&amp;rsquo;un vulgaire &lt;code>find $NOVAR/ -delete&lt;/code> durant des tests.&lt;/p>
&lt;p>Après cet épisode et l&amp;rsquo;amertume d&amp;rsquo;avoir perdu quelques travaux, ou la surprise
de découvrir les ravages de leur disparition plusieurs semaines après ma fatale
erreur, je me suis tourné vers l&amp;rsquo;outil incontournable dont tous mes collègues me
parlaient : &lt;a href="https://borgbackup.readthedocs.io/en/stable/" target="_blank" rel="noopener">BorgBackup&lt;/a>&lt;/p>
&lt;hr>
&lt;h2 id="des-atouts-séduisants">Des atouts séduisants&lt;/h2>
&lt;p>Cela fait à présent deux années que je travaille au quotidien sur Linux pour mon
activité professionnelle. Étant responsable de mon matériel et des données que
je manipule, il n&amp;rsquo;existe pas de politique particulière pour les sauvegardes
régulières ni le stockage de celles-ci.&lt;/p>
&lt;p>Mon précédent script était passablement trivial, à savoir :&lt;/p>
&lt;ul>
&lt;li>Sauvegarder une copie unique des documents courants ;&lt;/li>
&lt;li>Sauvegarder une liste des fichiers de configuration, appelés &lt;em>dotfiles&lt;/em> ;&lt;/li>
&lt;li>Exclure les projets contenant un répertoire &lt;code>.git&lt;/code> ;&lt;/li>
&lt;li>Exclure les fichiers de plus de 200 Mo.&lt;/li>
&lt;/ul>
&lt;p>Le tout sur une clé USB de 8 Go, chiffrée avec le système &lt;a href="https://fr.wikipedia.org/wiki/LUKS" target="_blank" rel="noopener">LUKS&lt;/a> pour se
prévenir de la perte ou du vol dans un espace public dudit support.&lt;/p>
&lt;p>Borg (son petit nom), permet de répondre correctement à l&amp;rsquo;ensemble de ces
points, et le fait à merveille. En bénéficiant de la déduplication et de la
compression, j&amp;rsquo;ai pu conserver ma clé USB et m&amp;rsquo;engager dans la rédaction d&amp;rsquo;un
&lt;a href="https://gist.github.com/fljdin/de46c7c8d18cc37e591cb8364ecf8eef" target="_blank" rel="noopener">nouveau script&lt;/a> plus complet.&lt;/p>
&lt;p>&lt;strong>Exclusion de fichiers et de répertoires&lt;/strong>&lt;/p>
&lt;p>Certains fichiers ou répertoires cachés vivent leur vie sur nos postes, et un
fichier d&amp;rsquo;exclusion peut être transmis à Borg pour ne pas les inclure dans la
routine de sauvegarde. Le mien est relativement léger pour le moment, et
pourrait s&amp;rsquo;enrichir avec l&amp;rsquo;expérience.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ~/.config/borg/exclude.list &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/home/**/.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/home/**/.vagrant
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/home/*/.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/home/*/.cache
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/home/*/.mozilla
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/home/*/.thunderbird
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/home/*/.config/chromium
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/home/*/.config/discord
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/home/*/.npm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/home/*/.cpan
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>Déduplication et rétention d&amp;rsquo;une semaine&lt;/strong>&lt;/p>
&lt;p>Le gain remarquable entre mon script et la nouvelle solution que m&amp;rsquo;offre Borg
réside dans son algorithme de déduplication, où la version d&amp;rsquo;un fichier n&amp;rsquo;est
stockée qu&amp;rsquo;une seule fois jusqu&amp;rsquo;à une éventuelle modification, permettant de ne
conserver qu&amp;rsquo;une copie de mes documents sur une bien plus longue période avec
un coût de stockage ridiculement faible.&lt;/p>
&lt;p>À chaque exécution, je demande le rapport de sauvegarde avec l&amp;rsquo;option &lt;code>--stats&lt;/code>
dont voici un exemplaire sur l&amp;rsquo;exécution de ce matin.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">------------------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Archive name: florent-2021-08-24T08:42:05
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Archive fingerprint: be38707dd52f5a86f8e75fe3ad4997aae58b3016366a988b7cb37ce3b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Time &lt;span class="o">(&lt;/span>start&lt;span class="o">)&lt;/span>: Tue, 2021-08-24 08:42:06
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Time &lt;span class="o">(&lt;/span>end&lt;span class="o">)&lt;/span>: Tue, 2021-08-24 08:42:06
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Duration: 0.96 seconds
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Number of files: &lt;span class="m">3720&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Utilization of max. archive size: 0%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Original size Compressed size Deduplicated size
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">This archive: 2.11 GB 1.78 GB 480.51 kB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">All archives: 12.63 GB 10.67 GB 1.75 GB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Unique chunks Total chunks
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Chunk index: &lt;span class="m">3974&lt;/span> &lt;span class="m">25888&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Pour une semaine de rétention, l&amp;rsquo;espace total consommé sur le montage USB
n&amp;rsquo;excède pas (encore) les 1,75 Go alors que les images décompressées pèsent au
total 12,63 Go que ne parvennait pas à stocker mon ancien script sur plusieurs
jours.&lt;/p>
&lt;p>Au passage, la durée d&amp;rsquo;exécution est significativement réduite chaque jour grâce
à ce mécanisme, qui ne sélectionne que les nouveautés d&amp;rsquo;une exécution à l&amp;rsquo;autre.&lt;/p>
&lt;p>&lt;strong>Un montage virtuel pour naviguer dans le temps&lt;/strong>&lt;/p>
&lt;p>L&amp;rsquo;outil propose deux options pour la restauration :&lt;/p>
&lt;ul>
&lt;li>&lt;code>extract&lt;/code> pour restaurer le contenu d&amp;rsquo;une archive dans le répertoire courant
(&lt;a href="https://borgbackup.readthedocs.io/en/stable/usage/extract.html" target="_blank" rel="noopener">doc&lt;/a>) ;&lt;/li>
&lt;li>&lt;code>mount&lt;/code> pour visualiser les fichiers ou dossiers à restaurer, voire les
déplacer manuellement dans le répertoire cible avec un outil graphique
(&lt;a href="https://borgbackup.readthedocs.io/en/stable/usage/mount.html" target="_blank" rel="noopener">doc&lt;/a>).&lt;/li>
&lt;/ul>
&lt;p>Cette seconde proposition est particulièrement utile pour naviguer d&amp;rsquo;une archive
à une autre, à la recherche d&amp;rsquo;un fichier perdu dans le temps. Le montage
s&amp;rsquo;effectue à l&amp;rsquo;aide du système de fichiers &lt;a href="https://www.kernel.org/doc/html/latest/filesystems/fuse.html" target="_blank" rel="noopener">FUSE&lt;/a> qui ne nécessite aucun
droit administrateur.&lt;/p>
&lt;p>Pour être utilisé à partir de Borg, le paquet &lt;code>python-llfuse&lt;/code> sera requis selon
votre distribution.&lt;/p>
&lt;h2 id="planification-avec-systemctl">Planification avec systemctl&lt;/h2>
&lt;p>Ce fut une découverte lors de mes lectures émerveillées de la &lt;a href="https://gist.github.com/fljdin/de46c7c8d18cc37e591cb8364ecf8eef" target="_blank" rel="noopener">documentation&lt;/a>
et des &lt;a href="https://wiki.archlinux.org/title/Borg_backup_%28Fran%C3%A7ais%29" target="_blank" rel="noopener">ressources&lt;/a> de la communauté française d&amp;rsquo;Archlinux. N&amp;rsquo;étant pas
particulièrement fan de &lt;code>cron&lt;/code> pour un usage personnel, j&amp;rsquo;ai suivi à la lettre
la configuration d&amp;rsquo;un service utilisateur et du &lt;em>timer&lt;/em> associé pour garantir le
lancement de la sauvegarde chaque jour, 30 minutes après le démarrage de mon
système.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># .config/systemd/user/borg.service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Unit]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Description&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">Borg backup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Service]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">oneshot&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">%h/.bin/borg-create.sh&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># .config/systemd/user/borg.timer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Unit]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Description&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">Daily Borg backup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Documentation&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">man:borg&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Timer]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">OnBootSec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">30min&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">OnUnitActiveSec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">1d&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Install]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">WantedBy&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">timers.target&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Une fois le service activé, je n&amp;rsquo;ai qu&amp;rsquo;à attendre chaque matin la notification
de fin de sauvegarde pour consulter les rapports avec la commande &lt;code>journalctl&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">journalctl --user -xeu borg.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">août &lt;span class="m">24&lt;/span> 08:42:02 florent systemd&lt;span class="o">[&lt;/span>877&lt;span class="o">]&lt;/span>: Starting Borg backup...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">août &lt;span class="m">24&lt;/span> 08:42:27 florent systemd&lt;span class="o">[&lt;/span>877&lt;span class="o">]&lt;/span>: Finished Borg backup.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">août &lt;span class="m">24&lt;/span> 08:42:27 florent systemd&lt;span class="o">[&lt;/span>877&lt;span class="o">]&lt;/span>: borg.service: Consumed 1.535s CPU time.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>De trop nombreux utilisateurs (Windows notamment) comptent sur leur miraculeuse
corbeille, jusqu&amp;rsquo;à ce qu&amp;rsquo;une véritable suppression ne survienne ou qu&amp;rsquo;un disque
défaillant fasse des siennes. Pour s&amp;rsquo;assurer qu&amp;rsquo;une donnée ne disparaisse pas
définitivement, la sauvegarde doit être correctement mise en place, idéalement
sur plusieurs périodes et sur plusieurs supports.&lt;/p>
&lt;p>Le conseil vaut aussi bien pour les bases de données que pour les fichiers
personnels : une sauvegarde n&amp;rsquo;est fiable que si la restauration de son
contenu est possible. Une corruption de l&amp;rsquo;archive, une erreur dans l&amp;rsquo;exécution
du script ou une mise à jour majeure de l&amp;rsquo;outil de sauvegarde sont autant de
situations qui peuvent rendre vos sauvegardes irrécupérables.&lt;/p>
&lt;p>Prenez soin de vos sauvegardes.&lt;/p></description></item><item><title>Compiler et patcher avec pgenv</title><link>https://fljd.in/2020/12/21/compiler-et-patcher-avec-pgenv/</link><pubDate>Mon, 21 Dec 2020 00:00:00 +0000</pubDate><author>Florent Jardin</author><guid>https://fljd.in/2020/12/21/compiler-et-patcher-avec-pgenv/</guid><description>&lt;p>Parmi les quelques outils de mon quotidien, il y en a un très sobre et bigrement
efficace répondant au nom de &lt;a href="https://github.com/theory/pgenv" target="_blank" rel="noopener">pgenv&lt;/a>, un gestionnaire des versions PostgreSQL.
Ce projet est publié sous licence MIT par David E. Wheeler, auteur de l&amp;rsquo;extension
pgTAP dont j&amp;rsquo;avais déjà vanté les mérites dans un &lt;a href="https://fljd.in/2020/05/14/ecrire-ses-tests-unitaires-en-sql">autre article&lt;/a>.&lt;/p>
&lt;p>Cet outil concerne principalement les contributeur⋅rices au projet PostgreSQL et les
quelques DBA féru⋅es d&amp;rsquo;expérimentations, car &lt;code>pgenv&lt;/code> permet de compiler et
d&amp;rsquo;exécuter toutes les versions majeures et mineures du système de base de données
open-source le plus avancé du monde.&lt;/p>
&lt;hr>
&lt;h2 id="à-lépreuve-de-la-compilation">À l&amp;rsquo;épreuve de la compilation&lt;/h2>
&lt;p>PostgreSQL est particulièrement simple à compiler. Avec un poste de travail
sous Unix, GNU/Linux ou BSD et quelques dépendances, à savoir &lt;code>gcc&lt;/code>, &lt;code>make&lt;/code>,
&lt;code>patch&lt;/code> et &lt;code>git&lt;/code>, il est facile d&amp;rsquo;exécuter une instance dans la version cible de son
choix.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git clone git://git.postgresql.org/git/postgresql.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> postgresql
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git checkout REL_13_1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">PREFIX&lt;/span>&lt;span class="o">=&lt;/span>/tmp/postgres/devel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ./configure --prefix&lt;span class="o">=&lt;/span>&lt;span class="nv">$PREFIX&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ make &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> make install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> contrib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ make &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> make install
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Dès lors que les librairies et les binaires sont disponibles, il est très aisé
de contruire sa première instance et de s&amp;rsquo;y connecter !&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$PREFIX&lt;/span>/bin:&lt;span class="nv">$PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">LD_LIBRARY_PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$PREFIX&lt;/span>/lib:&lt;span class="nv">$LD_LIBRARY_PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">PGDATA&lt;/span>&lt;span class="o">=&lt;/span>/tmp/postgres/data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ initdb --username &lt;span class="k">$(&lt;/span>whoami&lt;span class="k">)&lt;/span> --auth&lt;span class="o">=&lt;/span>peer --data-checksums
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ pg_ctl start --log&lt;span class="o">=&lt;/span>&lt;span class="nv">$PGDATA&lt;/span>/server.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ createdb &lt;span class="k">$(&lt;/span>whoami&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ psql -tc &lt;span class="s2">&amp;#34;select version()&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PostgreSQL 13.1 on x86_64-pc-linux-gnu, compiled by gcc &lt;span class="o">(&lt;/span>GCC&lt;span class="o">)&lt;/span> 10.2.0, 64-bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ pg_ctl stop
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Le faire à la main m&amp;rsquo;a amusé quelques minutes et écrire un script pour automatiser
le déploiement des versions mineures à la demande m&amp;rsquo;a vite traversé l&amp;rsquo;esprit.
Ne réinventons pas la roue et voyons ce que propose &lt;code>pgenv&lt;/code> !&lt;/p>
&lt;hr>
&lt;h2 id="un-script-pour-les-compiler-tous">Un script pour les compiler tous&lt;/h2>
&lt;p>La &lt;a href="https://github.com/theory/pgenv" target="_blank" rel="noopener">page d&amp;rsquo;accueil&lt;/a> du projet reprend l&amp;rsquo;installation rapide du script dans votre
sous-répertoire &lt;code>~/.pgenv&lt;/code>. Téléchargeons et compilons la version qui nous interesse.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">$ pgenv available
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Available PostgreSQL Versions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">================================================
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PostgreSQL 10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 10.0 10.1 10.2 10.3 10.4 10.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 10.6 10.7 10.8 10.9 10.10 10.11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 10.12 10.13 10.14 10.15
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PostgreSQL 11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 11.0 11.1 11.2 11.3 11.4 11.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 11.6 11.7 11.8 11.9 11.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PostgreSQL 12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 12.0 12.1 12.2 12.3 12.4 12.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PostgreSQL 13
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 13beta1 13beta2 13beta3 13rc1 13.0 13.1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Comme pour mon précédent exemple, je réinstalle une version 13.1 avec &lt;code>pgenv&lt;/code>
à l&amp;rsquo;aide de l&amp;rsquo;option &lt;code>build&lt;/code>. Le script déploie également les librairies de &lt;em>contrib&lt;/em>
et la documentation.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">PGENV_ROOT&lt;/span>&lt;span class="o">=&lt;/span>/var/lib/pgenv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$PGENV_ROOT&lt;/span>/pgsql/bin:&lt;span class="nv">$PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">LD_LIBRARY_PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$PGENV_ROOT&lt;/span>/pgsql/lib:&lt;span class="nv">$LD_LIBRARY_PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ pgenv build 13.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PostgreSQL, contrib, and documentation installation complete.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pgenv configuration written to file /var/lib/pgenv/.pgenv.13.1.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PostgreSQL 13.1 built
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>On retrouve dans l&amp;rsquo;arborescence &lt;code>$PGENV_ROOT&lt;/code>, la présence de l&amp;rsquo;archive &lt;code>.tar.bz2&lt;/code>
du projet, requise pour l&amp;rsquo;étape de compilation. Le &lt;code>$PREFIX&lt;/code> quant à lui, est
automatiquement positionné sur le répertoire &lt;code>$PGENV_ROOT/pgsql-13.1&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">/var/lib/pgenv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── .pgenv.13.1.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── pgsql-13.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── include
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   ├── lib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│   └── share
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└── src
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ├── postgresql-13.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └── postgresql-13.1.tar.bz2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Pour être fidèle à ma première partie, je vais configurer correctement les
paramètres de la commande &lt;code>initdb&lt;/code> dans le fichier de configuration dédié à la
version 13.1.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ pgenv config edit 13.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Path to the cluster log file (mandatory)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PGENV_LOG&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PGENV_ROOT&lt;/span>&lt;span class="s2">/pgsql/data/server.log&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Initdb flags&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PGENV_INITDB_OPTS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;--username &lt;/span>&lt;span class="k">$(&lt;/span>whoami&lt;span class="k">)&lt;/span>&lt;span class="s2"> --auth=peer --data-checksums&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Ainsi, lors de la première utilisation de cette version 13.1, &lt;code>pgenv&lt;/code> va lancer
la commande &lt;code>initdb&lt;/code> pour alimenter le répertoire de données avec mon compte
comme propriétaire et démarrer le processus &lt;code>postgres&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ pgenv use 13.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Using PGENV_ROOT /var/lib/pgenv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Data page checksums are enabled.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Success. You can now start the database server using:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /var/lib/pgenv/pgsql/bin/pg_ctl -D /var/lib/pgenv/pgsql/data -l logfile start
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PostgreSQL 13.1 started
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Logging to /var/lib/pgenv/pgsql/data/server.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ createdb &lt;span class="k">$(&lt;/span>whoami&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ psql -tc &lt;span class="s2">&amp;#34;select version()&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PostgreSQL 13.1 on x86_64-pc-linux-gnu, compiled by gcc &lt;span class="o">(&lt;/span>GCC&lt;span class="o">)&lt;/span> 10.2.0, 64-bit
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h2 id="et-avec-ceci">Et avec ceci ?&lt;/h2>
&lt;p>Comme indiqué en introduction, l&amp;rsquo;intérêt d&amp;rsquo;un tel gestionnaire réside dans sa
capacité d&amp;rsquo;installer plusieurs versions différentes dans la même arborescence
et de basculer de l&amp;rsquo;une à l&amp;rsquo;autre.&lt;/p>
&lt;p>Imaginons que nous souhaitons disposer d&amp;rsquo;une version 10 de PostgreSQL avec le
même genre de configuration que la version 13 précédente. &lt;code>pgenv&lt;/code> supporte un
fichier d&amp;rsquo;environnement global, nommé &lt;code>.pgenv.conf&lt;/code>, que je reconstruis à
partir de mon précédent fichier d&amp;rsquo;instance 13.1.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cp &lt;span class="nv">$PGENV_ROOT&lt;/span>/.pgenv.13.1.conf &lt;span class="nv">$PGENV_ROOT&lt;/span>/.pgenv.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ pgenv build 10.15
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ pgenv use latest &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ createdb &lt;span class="k">$(&lt;/span>whoami&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ psql -c &lt;span class="s2">&amp;#34;show data_checksums&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> data_checksums
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ----------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> row&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Nous nous retrouvons bien avec un instance dont les sommes de contrôle ont été
activées, grâce à l&amp;rsquo;option &lt;code>PGENV_INITDB_OPTS&lt;/code> citée plus haut.&lt;/p>
&lt;p>Je m&amp;rsquo;étais questionné sur la capacité de &lt;code>pgenv&lt;/code> de lancer simultanément deux
environnements pour mettre en place de la réplication logique, par exemple.
Conclusion, il s&amp;rsquo;agit d&amp;rsquo;une des limites de l&amp;rsquo;outil, puisque ce n&amp;rsquo;est pas
son but premier. Et pour cause, à chaque fois que l&amp;rsquo;on appelle la commande
&lt;code>pgenv use&lt;/code>, le script arrête l&amp;rsquo;instance courante avant de basculer sur la
deuxième.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ pgenv use latest &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Using PGENV_ROOT /var/lib/pgenv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PostgreSQL 13.1 stopped
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PostgreSQL 10.15 started
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Logging to /var/lib/pgenv/pgsql/data/server.log
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>En complément, &lt;code>pgenv&lt;/code> met en place un lien symbolique dans la racine &lt;code>$PGENV_ROOT&lt;/code>
à chaque changement de version courante. Ce lien a été ajouté au préalable
dans la variable &lt;code>$PATH&lt;/code> pour garantir la bonne compatibilité des binaires avec
les données.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">/var/lib/pgenv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── .pgenv.13.1.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── .pgenv.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── pgsql -&amp;gt; pgsql-10.15
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── pgsql-10.15
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── pgsql-13.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└── src
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Ce lien symbolique nous oblige à manipuler toutes les autres instances avec des
chemins absolus, une surcharge de leurs paramètres &lt;code>port&lt;/code> ou &lt;code>listen_addresses&lt;/code>
et de faire appel à la bonne version de la commande &lt;code>pg_ctl&lt;/code>. Il est donc possible
de faire de la réplication, mais oubliez &lt;code>pgenv&lt;/code> pour la gestion des processus
d&amp;rsquo;instances.&lt;/p>
&lt;hr>
&lt;h2 id="dans-la-cour-des-grands">Dans la cour des grands&lt;/h2>
&lt;p>Nous sommes en décembre 2020 à l&amp;rsquo;heure de la rédaction de cet article, et la
communauté PostgreSQL travaille activement sur le développement de la prochaine
version 14 du logiciel. Chaque année, les contributeur⋅rices du monde entier
se retrouvent en ligne autour du &lt;em>&lt;a href="https://commitfest.postgresql.org/" target="_blank" rel="noopener">Commitfest&lt;/a>&lt;/em> pour étudier les nouvelles
propositions de fonctionnalités ou de correction de bogues.&lt;/p>
&lt;p>En août dernier, Tatsuro Yamada proposait d&amp;rsquo;&lt;a href="https://www.postgresql.org/message-id/flat/c027a541-5856-75a5-0868-341301e1624b@nttcom.co.jp_1" target="_blank" rel="noopener">enrichir&lt;/a> les méta-commandes de
l&amp;rsquo;invite &lt;code>psql&lt;/code> afin de lister les &lt;a href="https://www.postgresql.org/docs/12/planner-stats.html#PLANNER-STATS-EXTENDED" target="_blank" rel="noopener">statistiques étendues&lt;/a> rattachées aux
tables de la base courante. Cette fonctionnalité est donc étudiée à travers les
échanges électroniques et suivie sur &lt;a href="https://commitfest.postgresql.org/31/2801/" target="_blank" rel="noopener">une page dédiée&lt;/a> du &lt;em>Commitfest&lt;/em>.&lt;/p>
&lt;p>Le contributeur produit alors un fichier &lt;code>.patch&lt;/code> qu&amp;rsquo;il obtient avec la commande
&lt;code>git diff&lt;/code> et dont le résultat est compatible avec la commande &lt;a href="https://www.man7.org/linux/man-pages/man1/patch.1.html" target="_blank" rel="noopener">patch&lt;/a>. Ainsi,
n&amp;rsquo;importe quel relecteur peut l&amp;rsquo;intégrer dans son projet et dérouler ses tests sur
la nouvelle instance compilée.&lt;/p>
&lt;p>C&amp;rsquo;est là qu&amp;rsquo;intervient une chouette fonctionnalité de l&amp;rsquo;outil &lt;code>pgenv&lt;/code>. Ce dernier
propose d&amp;rsquo;appliquer une série de patchs dans une phase préliminaire dès lors qu&amp;rsquo;on
lui présente un fichier d&amp;rsquo;index pour la version associée, qui contiendra le chemin
absolu des fichiers à parcourir.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">/var/lib/pgenv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└── patch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    ├── 13
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> │   └── 0001-Add-dX-command-on-psql-rebased-on-7e5e1bba03.patch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    └── index
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └── patch.13
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Comme on le voit dans mon arborescence, j&amp;rsquo;ai téléchargé la dernière version
communiquée par le développeur et je l&amp;rsquo;ai déclarée dans le fichier &lt;code>index.13&lt;/code>.
Lors de la recompilation de la version concernée, on constate que le patch
est bien pris en compte.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">PGENV_DEBUG&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ pgenv clear
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ pgenv rebuild 13.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Using PGENV_ROOT /var/lib/pgenv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>DEBUG&lt;span class="o">]&lt;/span> Patch index file &lt;span class="o">[&lt;/span>/var/lib/pgenv/patch/index/patch.13&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>DEBUG&lt;span class="o">]&lt;/span> Applying patch &lt;span class="o">[&lt;/span>0001-Add-dX-command-on-psql-rebased-on-7e5e1bba03.patch&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> into &lt;span class="nb">source&lt;/span> tree /var/lib/pgenv/src/postgresql-13.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Applied patch 0001-Add-dX-command-on-psql-rebased-on-7e5e1bba03.patch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PostgreSQL 13.1 built
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Et la fonctionnalité devient disponible sur l&amp;rsquo;instance !&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">florent=# \dX
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> List of extended statistics
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Schema | Name | Definition | Ndistinct | Dependencies | MCV
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--------+-------+--------------+-----------+--------------+---------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> public | stts1 | a, b FROM t1 | | defined |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> public | stts2 | a, b FROM t1 | defined | defined |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> public | stts3 | a, b FROM t1 | defined | defined | defined
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> public | stts4 | b, c FROM t2 | defined | defined | defined
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">(4 rows)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Le retrait des patchs n&amp;rsquo;est pas supporté par &lt;code>pgenv&lt;/code> mais l&amp;rsquo;opération reste
triviale avec la commande &lt;code>patch&lt;/code> et son option &lt;code>--reverse&lt;/code>. Cela nous permet
de conserver les sources sans devoir les télécharger à nouveau !&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> &lt;span class="nv">$PGENV_ROOT&lt;/span>/src/postgresql-13.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nv">index&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$PGENV_ROOT&lt;/span>/patch/index/patch.13
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="k">for&lt;/span> f in &lt;span class="k">$(&lt;/span>cat &lt;span class="nv">$index&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span> patch --reverse -p1 &amp;lt; &lt;span class="nv">$f&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">patching file doc/src/sgml/ref/psql-ref.sgml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hunk &lt;span class="c1">#1 succeeded at 1903 (offset -15 lines).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">patching file src/bin/psql/command.c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hunk &lt;span class="c1">#1 succeeded at 929 (offset 1 line).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">patching file src/bin/psql/describe.c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hunk &lt;span class="c1">#1 succeeded at 4377 (offset -24 lines).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">patching file src/bin/psql/describe.h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">patching file src/bin/psql/help.c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">patching file src/bin/psql/tab-complete.c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hunk &lt;span class="c1">#1 succeeded at 1479 (offset -21 lines).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hunk &lt;span class="c1">#2 succeeded at 3771 (offset -127 lines).&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>Pour tout vous dire, je ne sais plus me séparer de &lt;code>pgenv&lt;/code> sauf en de rares
exceptions où mes tests nécessitent une distribution GNU/Linux spécifique, comme
CentOS ou Debian. Une machine virtuelle fournie par &lt;a href="https://www.vagrantup.com/docs/boxes" target="_blank" rel="noopener">Vagrant&lt;/a> est tout aussi
fiable, notamment lorsqu&amp;rsquo;il s&amp;rsquo;agit de déboguer un paquet d&amp;rsquo;installation ou
une dépendance particulière.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">$ sudo vagrant box list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">centos/7 (libvirt, 2004.01)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">debian/buster64 (libvirt, 10.4.0)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">debian/stretch64 (libvirt, 9.12.0)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>