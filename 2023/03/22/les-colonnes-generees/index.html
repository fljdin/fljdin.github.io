<!doctype html><html lang=fr><head><title>Les colonnes générées</title>
<link rel=stylesheet href=https://fljd.in/css/main.min.css><link rel=apple-touch-icon sizes=180x180 href=/ico/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/ico/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/ico/favicon-16x16.png><link rel=manifest href=/ico/site.webmanifest><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8></head><body><div class="container content"><header class=homepage><h3 class=homepage-title><a href=/ title></a><small><a href=/index.xml><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#rss"/></svg></a>
<a href=https://fosstodon.org/@fljdin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#mastodon"/></svg></a>
<a href=https://github.com/fljdin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#github"/></svg></a>
<a href=https://www.linkedin.com/in/florent-jardin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#linkedin"/></svg></a>
&nbsp;&nbsp;<a href=/conferences>Conférences</a>&nbsp;&nbsp;<a href=/archives>Archives</a>&nbsp;&nbsp;<a href=/a-propos>À propos</a></small></h3></header><main><article class=post><h1 class=post-title>Les colonnes générées</a></h1><p class=post-date><time datetime=2023-03-22>22 mars 2023</time>
- 7 minutes de lecture</p><p>La norme ISO SQL/Foundation (<a href=https://www.iso.org/standard/63556.html target=_blank rel=noopener>ISO/IEC 9075-2:2016</a>) fait partie du standard
SQL et définit les règles pour la définition des relations et la manipulation
des données. En adoptant cette norme, les moteurs de bases de données
garantissent une interopérabilité avec leurs concurrents et permettent aux
entreprises de bénéficier d&rsquo;une plus grande flexibilité lorsqu&rsquo;elles souhaitent
passer de l&rsquo;un à l&rsquo;autre sans (trop) réécrire leur modèle de données ou leurs
requêtes SQL.</p><p>Dans sa publication SQL:2003, la norme a introduit le concept de <strong>colonnes
générées</strong> comme nouvelle spécification technique. Parfois appelées <em>colonnes
calculées</em> ou <em>colonnes virtuelles</em>, leurs valeurs dérivent de celles des autres
colonnes de la table. <a href=https://modern-sql.com/caniuse/generated-always-as target=_blank rel=noopener>Un des articles</a> de Markus Winand passe au crible les
différents systèmes du marché pour voir s&rsquo;ils respectent ce standard.</p><hr><h2 id=une-apparition-tardive-dans-postgresql>Une apparition tardive dans PostgreSQL</h2><p>Une analogie issue de la <a href=https://www.postgresql.org/docs/12/ddl-generated-columns.html target=_blank rel=noopener>documentation</a> permet de se faire une idée assez
précise de ce que les deux types de colonnes générées peuvent nous apporter :</p><blockquote><p>Une colonne générée virtuelle n&rsquo;occupe pas d&rsquo;espace et est calculée à la
lecture. Une colonne générée virtuelle est donc équivalente à une vue, et une
colonne générée stockée est équivalente à une vue matérialisée (sauf qu&rsquo;elle
sera toujours mise à jour automatiquement).</p></blockquote><p>Les cas d&rsquo;utilisations sont multiples et permettent de définir au plus proche de
la structure de la table, les informations transformées que les utilisateurs
peuvent consulter sans se soucier des règles métiers nécessaires pour les
obtenir. Par exemple :</p><ul><li>Calcul arithmétique sur une ou plusieurs valeurs de la ligne, comme
l&rsquo;application d&rsquo;une taxe sur le tarif d&rsquo;un produit ;</li><li>Calcul de la distance entre deux points géométriques à l&rsquo;aide de l&rsquo;extension
PostGIS ;</li><li>Calcul de l&rsquo;intervalle entre deux données temporelles, par exemple la durée
d&rsquo;exécution d&rsquo;une tâche sur la base du début et de la fin de son exécution ;</li><li>Contrôle de la validité d&rsquo;une ligne en retournant <code>true</code> ou <code>false</code> ;</li><li>Extraction d&rsquo;un élément depuis un type complexe comme <code>JSON</code> ou <code>ARRAY</code>,
notamment pour bénéficier de mécanismes comme la collecte de statistiques ou
l&rsquo;indexation.</li></ul><p>Il fallut attendre la version 12 de PostgreSQL, sortie en octobre 2019, pour
pouvoir bénéficier de la syntaxe standardisée <code>GENERATED ALWAYS AS</code>, bien que le
respect de la norme soit partiel. Dans la course à la normalisation, les
systèmes DB2 d&rsquo;IBM et Oracle Database sont les plus avancés comme le montre
l&rsquo;illustration ci-dessous, issue de l&rsquo;article de Markus Winand.</p><p><img src=/img/fr/2023-03-22-generated-columns-support.png></p><p>À ce jour, PostgreSQL n&rsquo;implémente que les colonnes générées dites <strong>stockées</strong>.
Ces dernières sont calculées lorsqu&rsquo;une modification de la ligne a lieu
(<code>INSERT</code> et <code>UPDATE</code>) et leurs valeurs sont stockées au même titre que les
autres colonnes dans le fichier de la table.</p><hr><h2 id=une-colonne-haute-en-couleur>Une colonne haute en couleur</h2><p>Prenons l&rsquo;exemple d&rsquo;une table <code>colors</code> qui reprend la <a href=https://www.w3schools.com/colors/colors_names.asp target=_blank rel=noopener>palette</a> de
140 couleurs disponibles avec les classes CSS. Nous souhaitons que les valeurs
décimales du mode RGB (<em>Red</em>, <em>Green</em>, <em>Blue</em>) soient pré-calculées à partir de
la valeur hexadécimale de la couleur.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>colors</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>name</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>code_hex</span><span class=w> </span><span class=nb>char</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>CHECK</span><span class=w> </span><span class=p>(</span><span class=n>code_hex</span><span class=w> </span><span class=o>~*</span><span class=w> </span><span class=s1>&#39;^[0-9A-F]{6}$&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><div class=message>Les instructions <code>INSERT</code> sont disponibles sur mon <a href=https://github.com/fljdin/database-samples/blob/master/en-colors-code-hex.sql target=_blank rel=noopener>dépôt Github</a>.</div><p>Cette transformation nécessite de manipuler la colonne <code>code_hex</code> dans sa
représentation hexadécimale grâce à une conversion en <code>bytea</code>. Ensuite, la
fonction <code>get_byte</code> de PostgreSQL permet d&rsquo;obtenir la valeur de chaque octet en
valeur décimale. Pour ma démonstration, je vais m&rsquo;appuyer sur une fonction SQL
qui sera responsable de l&rsquo;extraction des trois octets et me retournera un type
personnalisé <code>rgb</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>DOMAIN</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>smallint</span><span class=w> </span><span class=k>CHECK</span><span class=w> </span><span class=p>(</span><span class=n>VALUE</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=mi>255</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TYPE</span><span class=w> </span><span class=n>rgb</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=n>red</span><span class=w> </span><span class=n>color</span><span class=p>,</span><span class=w> </span><span class=n>green</span><span class=w> </span><span class=n>color</span><span class=p>,</span><span class=w> </span><span class=n>blue</span><span class=w> </span><span class=n>color</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=k>FUNCTION</span><span class=w> </span><span class=n>hex_to_rgb</span><span class=p>(</span><span class=n>code</span><span class=w> </span><span class=nb>char</span><span class=p>(</span><span class=mi>6</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>RETURNS</span><span class=w> </span><span class=n>rgb</span><span class=w> </span><span class=k>LANGUAGE</span><span class=w> </span><span class=k>sql</span><span class=w> </span><span class=k>IMMUTABLE</span><span class=w> </span><span class=n>PARALLEL</span><span class=w> </span><span class=n>SAFE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>RETURN</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>get_byte</span><span class=p>(</span><span class=n>concat</span><span class=p>(</span><span class=s1>&#39;\x&#39;</span><span class=p>,</span><span class=w> </span><span class=n>code</span><span class=p>)::</span><span class=n>bytea</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>get_byte</span><span class=p>(</span><span class=n>concat</span><span class=p>(</span><span class=s1>&#39;\x&#39;</span><span class=p>,</span><span class=w> </span><span class=n>code</span><span class=p>)::</span><span class=n>bytea</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>get_byte</span><span class=p>(</span><span class=n>concat</span><span class=p>(</span><span class=s1>&#39;\x&#39;</span><span class=p>,</span><span class=w> </span><span class=n>code</span><span class=p>)::</span><span class=n>bytea</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Enfin, je peux ajouter une nouvelle colonne générée à ma table <code>colors</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>colors</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=n>code_rgb</span><span class=w> </span><span class=n>rgb</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>GENERATED</span><span class=w> </span><span class=n>ALWAYS</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=n>hex_to_rgb</span><span class=p>(</span><span class=n>code_hex</span><span class=p>))</span><span class=w> </span><span class=n>STORED</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Attention : lors de l&rsquo;ajout de cette colonne, PostgreSQL va réécrire la table
intégralement vers un nouveau fichier. Il profite alors de cette étape pour
calculer les données de la colonne générée et les stocker aux côtés des autres
colonnes de chaque ligne.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>colors</span><span class=w> </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>      name      | code_hex |   code_rgb    
</span></span><span class=line><span class=cl>----------------+----------+---------------
</span></span><span class=line><span class=cl> AliceBlue      | F0F8FF   | (240,248,255)
</span></span><span class=line><span class=cl> AntiqueWhite   | FAEBD7   | (250,235,215)
</span></span><span class=line><span class=cl> Aqua           | 00FFFF   | (0,255,255)
</span></span><span class=line><span class=cl> Aquamarine     | 7FFFD4   | (127,255,212)
</span></span><span class=line><span class=cl> Azure          | F0FFFF   | (240,255,255)
</span></span></code></pre></div><hr><h2 id=émuler-des-colonnes-virtuelles>Émuler des colonnes virtuelles</h2><p>Comme nous venons de le voir, PostgreSQL ne supporte que le mode stocké des
colonnes générées à l&rsquo;heure de la rédaction de cet article. Plusieurs
inconvénients découlent de son implémentation :</p><ul><li>L&rsquo;ajout d&rsquo;une nouvelle colonne générée implique la réécriture de la table,
avec des verrous passablement contraignants sur des tables fortement
sollicitées ;</li><li>À l&rsquo;image d&rsquo;un mauvais usage des triggers, les colonnes générées peuvent
ralentir les opérations d&rsquo;écriture (<code>INSERT</code> et <code>UPDATE</code>).</li><li>Si le corps de la fonction est modifié, la transformation des données ne
s&rsquo;appliquera qu&rsquo;à la prochaine modification des lignes ;</li></ul><p>S&rsquo;engager sur la voie des colonnes générées ainsi proposées par PostgreSQL peut
se révéler rédhibitoire pour certains besoins. Dans la continuité de ma
démonstration avec la table <code>colors</code>, je souhaite l&rsquo;étendre pour prendre en
charge la <a href=https://en.wikipedia.org/wiki/HSL_and_HSV target=_blank rel=noopener>représentation HSV</a>, réputée pour son approche par la perception
d&rsquo;une couleur.</p><p>Le calcul de la teinte, de la saturation et de la luminosité repose sur
l&rsquo;intensité des couleurs rouge, verte et bleue que l&rsquo;on connait déjà grâce à
notre colonne générée <code>code_rgb</code>. Je me lance alors dans l&rsquo;implémentation de la
formule permettant de convertir un objet <code>rgb</code> en un nouvel objet <code>hsv</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>DOMAIN</span><span class=w> </span><span class=n>degree</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>smallint</span><span class=w> </span><span class=k>CHECK</span><span class=w> </span><span class=p>(</span><span class=n>VALUE</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=mi>360</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>DOMAIN</span><span class=w> </span><span class=n>percent</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>smallint</span><span class=w> </span><span class=k>CHECK</span><span class=w> </span><span class=p>(</span><span class=n>VALUE</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=mi>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TYPE</span><span class=w> </span><span class=n>hsv</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=n>hue</span><span class=w> </span><span class=n>degree</span><span class=p>,</span><span class=w> </span><span class=n>saturation</span><span class=w> </span><span class=n>percent</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=n>percent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=k>FUNCTION</span><span class=w> </span><span class=n>rgb_to_hsv</span><span class=p>(</span><span class=n>code</span><span class=w> </span><span class=n>rgb</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>RETURNS</span><span class=w> </span><span class=n>hsv</span><span class=w> </span><span class=k>LANGUAGE</span><span class=w> </span><span class=k>sql</span><span class=w> </span><span class=k>IMMUTABLE</span><span class=w> </span><span class=n>PARALLEL</span><span class=w> </span><span class=n>SAFE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AS</span><span class=w> </span><span class=err>$$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>WITH</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>(</span><span class=n>code</span><span class=p>).</span><span class=n>red</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>255</span><span class=p>.</span><span class=mi>0</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>red</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>(</span><span class=n>code</span><span class=p>).</span><span class=n>green</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>255</span><span class=p>.</span><span class=mi>0</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>green</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>(</span><span class=n>code</span><span class=p>).</span><span class=n>blue</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>255</span><span class=p>.</span><span class=mi>0</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>blue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>),</span><span class=w> </span><span class=n>math</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>least</span><span class=p>(</span><span class=n>red</span><span class=p>,</span><span class=w> </span><span class=n>green</span><span class=p>,</span><span class=w> </span><span class=n>blue</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>min</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>greatest</span><span class=p>(</span><span class=n>red</span><span class=p>,</span><span class=w> </span><span class=n>green</span><span class=p>,</span><span class=w> </span><span class=n>blue</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>max</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>greatest</span><span class=p>(</span><span class=n>red</span><span class=p>,</span><span class=w> </span><span class=n>green</span><span class=p>,</span><span class=w> </span><span class=n>blue</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>least</span><span class=p>(</span><span class=n>red</span><span class=p>,</span><span class=w> </span><span class=n>green</span><span class=p>,</span><span class=w> </span><span class=n>blue</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>dist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>color</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>dist</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>ELSE</span><span class=w> </span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>max</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>red</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=p>(</span><span class=n>green</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>blue</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>dist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>green</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>blue</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=mi>6</span><span class=w> </span><span class=k>ELSE</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>END</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>green</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=p>(</span><span class=n>blue</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>red</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>dist</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHEN</span><span class=w> </span><span class=n>blue</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=p>(</span><span class=n>red</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>green</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>dist</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>END</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>END</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>hue</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=k>max</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>ELSE</span><span class=w> </span><span class=n>dist</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>max</span><span class=w> </span><span class=k>END</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>saturation</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>max</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>color</span><span class=p>,</span><span class=w> </span><span class=n>math</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>$$</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Puisque notre formule repose sur la colonne générée <code>code_rgb</code>, il nous est
impossible de procéder comme dans l&rsquo;exemple précédent. Le message d&rsquo;erreur
est assez explicite :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>colors</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=n>code_hsv</span><span class=w> </span><span class=n>hsv</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>GENERATED</span><span class=w> </span><span class=n>ALWAYS</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=n>rgb_to_hsv</span><span class=p>(</span><span class=n>code_rgb</span><span class=p>))</span><span class=w> </span><span class=n>STORED</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ERROR: cannot use generated column &#34;code_rgb&#34; in column generation expression
</span></span><span class=line><span class=cl>DETAIL: A generated column cannot reference another generated column.
</span></span></code></pre></div><p>Pour contourner ce problème, il devient nécessaire de construire une vue étendue
de la table <code>colors</code> afin d&rsquo;exposer l&rsquo;information aux utilisateurs. Et comme
PostgreSQL reste fondamentalement un système relationnel orienté objet, j&rsquo;en
profite pour créer la fonction <code>code_hsv</code> qui prend en argument une ligne de la
table <code>colors</code> et qui sera appelée dans la vue comme s&rsquo;il s&rsquo;agissait d&rsquo;un
attribut de la relation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=k>FUNCTION</span><span class=w> </span><span class=n>code_hsv</span><span class=p>(</span><span class=n>color</span><span class=w> </span><span class=n>colors</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>RETURNS</span><span class=w> </span><span class=n>hsv</span><span class=w> </span><span class=k>LANGUAGE</span><span class=w> </span><span class=k>sql</span><span class=w> </span><span class=k>IMMUTABLE</span><span class=w> </span><span class=n>PARALLEL</span><span class=w> </span><span class=n>SAFE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>RETURN</span><span class=w> </span><span class=n>rgb_to_hsv</span><span class=p>(</span><span class=n>color</span><span class=p>.</span><span class=n>code_rgb</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>REPLACE</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>colors_with_hsv</span><span class=w> </span><span class=k>AS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>code_hex</span><span class=p>,</span><span class=w> </span><span class=n>code_rgb</span><span class=p>,</span><span class=w> </span><span class=n>colors</span><span class=p>.</span><span class=n>code_hsv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>colors</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><hr><h2 id=conclusion>Conclusion</h2><p>Les colonnes générées ne sont qu&rsquo;une forme de plus pour transformer et présenter
les données d&rsquo;une table. Avec la syntaxe introduit dans PostgreSQL 12 et son
mode stocké (<code>STORED</code>), l&rsquo;accès aux données ne nécessite plus de calculer chaque
valeur à la volée, au prix d&rsquo;un coût de stockage plus élevé. C&rsquo;est une histoire
de compromis à trouver en fonction de ses besoins et de l&rsquo;activité sur
l&rsquo;instance.</p><p>Pour en finir avec ma démonstration, la table <code>colors</code> a été enrichie des deux
nouvelles représentations RGB et HSV. La requête suivante me permet de retrouver
les noms de toutes les couleurs qui se rapprochent de notre perception du bleu.
Avec le modèle HSV, il s&rsquo;agit des couleurs dont la teinte est située entre 190°
et 250° sur le <a href=https://fr.wikipedia.org/wiki/Cercle_chromatique target=_blank rel=noopener>cercle chromatique</a> et dont la saturation est supérieure à 10.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>colors_with_hsv</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=p>(</span><span class=n>code_hsv</span><span class=p>).</span><span class=n>hue</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=mi>190</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=mi>250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=n>code_hsv</span><span class=p>).</span><span class=n>saturation</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>      name      | code_hex |   code_rgb    |   code_hsv    
</span></span><span class=line><span class=cl>----------------+----------+---------------+---------------
</span></span><span class=line><span class=cl> Blue           | 0000FF   | (0,0,255)     | (240,100,100)
</span></span><span class=line><span class=cl> CornflowerBlue | 6495ED   | (100,149,237) | (219,58,93)
</span></span><span class=line><span class=cl> DarkBlue       | 00008B   | (0,0,139)     | (240,100,55)
</span></span><span class=line><span class=cl> DarkSlateBlue  | 483D8B   | (72,61,139)   | (248,56,55)
</span></span><span class=line><span class=cl> DeepSkyBlue    | 00BFFF   | (0,191,255)   | (195,100,100)
</span></span></code></pre></div></article><aside class=related><h3>Suggestion d'articles</h3><ul class=related-posts><li><a href=https://fljd.in/2023/07/28/en-route-vers-la-liberte-avec-db_migrator/>En route vers la liberté avec db_migrator
<small><time datetime=2023-07-28>28 juil 2023</time></small></a></li><li><a href=https://fljd.in/2023/02/10/le-fenetrage-a-la-rescousse/>Le fenêtrage à la rescousse
<small><time datetime=2023-02-10>10 févr 2023</time></small></a></li><li><a href=https://fljd.in/2024/11/25/substituer-une-variable-dans-un-script-sql/>Substituer une variable dans un script SQL
<small><time datetime=2024-11-25>25 nov 2024</time></small></a></li></ul></aside></main><footer class=footer><small>&copy; 2019-<time datetime=2024-11-25>2024</time>
— <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.fr>Creative Commons License BY-NC-ND 4.0</a></small></footer></div></body></html>