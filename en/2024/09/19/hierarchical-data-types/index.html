<!doctype html><html lang=en><head><title>Hierarchical data types</title>
<link rel=stylesheet href=https://fljd.in/css/main.min.css><link rel=apple-touch-icon sizes=180x180 href=/ico/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/ico/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/ico/favicon-16x16.png><link rel=manifest href=/ico/site.webmanifest><meta name=fediverse:creator content="@fljdin@mastodon.tedomum.net"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8></head><body><div class="container content"><header class=homepage><h3 class=homepage-title><a href=/en title="Florent Jardin">Florent Jardin</a>
<small><a href=/index.xml><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#rss"/></svg></a>
<a href=https://mastodon.tedomum.net/@fljdin rel=me><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#mastodon"/></svg></a>
<a href=https://github.com/fljdin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#github"/></svg></a>
<a href=https://www.linkedin.com/in/florent-jardin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#linkedin"/></svg></a>
&nbsp;&nbsp;<a href=/en/talks>Talks</a>&nbsp;&nbsp;<a href=/en/archives>Archives</a>&nbsp;&nbsp;<a href=/en/about>About me</a></small></h3></header><main><article class=post><h1 class=post-title>Hierarchical data types</a></h1><p class=post-date><time datetime=2024-09-19>19 sep 2024</time>
- 5 minutes to read</p><div class="message translation">Cet article est disponible en Français : <a href=https://fljd.in/2024/09/19/les-types-hierarchiques/>Les types hiérarchiques</a>
<small>(2024-09-19)</small></div><p>The SQL standard defines a set of rules so that database systems can be interchangeable,
but there are small singularities in the wild. In this regard, the <code>hierarchyid</code> data type
provided by SQL Server is a striking example. If you are switching to PostgreSQL, two
solutions are available to you.</p><p>A first and simpler solution consists in linking each node to its parent using a new
<code>parentid</code> column and applying a foreign key constraint. Another, more complete approach
consists in using the <code>ltree</code> extension. This article deals with the latter case.</p><hr><h2 id=searching-for-descendants>Searching for descendants</h2><p>The <code>hierarchyid</code> type is designed to represent a <a href=https://learn.microsoft.com/en-us/sql/relational-databases/hierarchical-data-sql-server target=_blank rel=noopener>hierarchical relationship</a> as a binary
tree. It stores the list of successive nodes up to the root in a single column. Thus, the
node <code>/1/1/2/</code> represents a level 3 node, child of the node <code>/1/1/</code>, itself child of the
node <code>/1/</code>, itself child of the root <code>/</code>.</p><p>Many built-in methods are part of the Transact-SQL language to manipulate the data. They all
traverse the binary tree to quickly extract the desired information without having to join
the nodes of the table together.</p><ul><li><a href=https://learn.microsoft.com/en-us/sql/t-sql/data-types/tostring-database-engine target=_blank rel=noopener><code>ToString()</code></a> : returns the textual representation of the current node.</li><li><a href=https://learn.microsoft.com/en-us/sql/t-sql/data-types/getlevel-database-engine target=_blank rel=noopener><code>GetLevel()</code></a> : returns the depth level of the current node.</li><li><a href=https://learn.microsoft.com/en-us/sql/t-sql/data-types/getancestor-database-engine target=_blank rel=noopener><code>GetAncestor(n)</code></a> : returns the <code>n</code>-level node in the tree.</li><li><a href=https://learn.microsoft.com/en-us/sql/t-sql/data-types/getdescendant-database-engine target=_blank rel=noopener><code>GetDescendant(c1, c2)</code></a> : returns a new child node between two nodes.</li></ul><p>PostgreSQL brings us a new data type, <code>ltree</code>, to store hierarchical data. It is a complex data
type that can store labels up to 1,000 characters long, separated by dots. The path can contain
up to 65,635 labels.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=n>EXTENSION</span><span class=w> </span><span class=n>ltree</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=n>ltree</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>location</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>locationtype</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Earth&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Planet&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Europe&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Continent&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;France&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Country&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.1.1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Paris&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.1.2&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Spain&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Country&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.1.2.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Madrid&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.2&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;South-America&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Continent&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.2.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Brazil&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Country&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.2.1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Brasilia&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.2.2&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Bahia&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;State&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.2.2.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Salvador&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.3&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Antarctica&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Continent&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.3.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;McMurdo Station&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Looking for the depth level of a node becomes trivial with the <code>nlevel()</code> function provided
by the <code>ltree</code> extension.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=k>location</span><span class=p>,</span><span class=w> </span><span class=n>locationtype</span><span class=p>,</span><span class=w> </span><span class=n>nlevel</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>level</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>   id    |    location     | locationtype | level
</span></span></span><span class=line><span class=cl><span class=go>---------+-----------------+--------------+-------
</span></span></span><span class=line><span class=cl><span class=go> 1       | Earth           | Planet       |     1
</span></span></span><span class=line><span class=cl><span class=go> 1.1     | Europe          | Continent    |     2
</span></span></span><span class=line><span class=cl><span class=go> 1.1.1   | France          | Country      |     3
</span></span></span><span class=line><span class=cl><span class=go> 1.1.1.1 | Paris           | City         |     4
</span></span></span><span class=line><span class=cl><span class=go> 1.1.2   | Spain           | Country      |     3
</span></span></span><span class=line><span class=cl><span class=go> 1.1.2.1 | Madrid          | City         |     4
</span></span></span><span class=line><span class=cl><span class=go> 1.2     | South-America   | Continent    |     2
</span></span></span><span class=line><span class=cl><span class=go> 1.2.1   | Brazil          | Country      |     3
</span></span></span><span class=line><span class=cl><span class=go> 1.2.1.1 | Brasilia        | City         |     4
</span></span></span><span class=line><span class=cl><span class=go> 1.2.2   | Bahia           | State        |     3
</span></span></span><span class=line><span class=cl><span class=go> 1.2.2.1 | Salvador        | City         |     4
</span></span></span><span class=line><span class=cl><span class=go> 1.3     | Antarctica      | Continent    |     2
</span></span></span><span class=line><span class=cl><span class=go> 1.3.1   | McMurdo Station | City         |     3
</span></span></span><span class=line><span class=cl><span class=go> 2.1.1   | unknown         | State        |     3
</span></span></span><span class=line><span class=cl><span class=go>(14 rows)
</span></span></span></code></pre></div><p>Another method named <code>subpath()</code> allows you to retrieve a part of the path of a node. Let&rsquo;s
see how to get the parent node of each node in the table.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=k>location</span><span class=p>,</span><span class=w> </span><span class=n>locationtype</span><span class=p>,</span><span class=w> </span><span class=n>subpath</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>nlevel</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>parentid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>   id    |    location     | locationtype | parent
</span></span></span><span class=line><span class=cl><span class=go>---------+-----------------+--------------+--------
</span></span></span><span class=line><span class=cl><span class=go> 1       | Earth           | Planet       |
</span></span></span><span class=line><span class=cl><span class=go> 1.1     | Europe          | Continent    | 1
</span></span></span><span class=line><span class=cl><span class=go> 1.1.1   | France          | Country      | 1.1
</span></span></span><span class=line><span class=cl><span class=go> 1.1.1.1 | Paris           | City         | 1.1.1
</span></span></span><span class=line><span class=cl><span class=go> 1.1.2   | Spain           | Country      | 1.1
</span></span></span><span class=line><span class=cl><span class=go> 1.1.2.1 | Madrid          | City         | 1.1.2
</span></span></span><span class=line><span class=cl><span class=go> 1.2     | South-America   | Continent    | 1
</span></span></span><span class=line><span class=cl><span class=go> 1.2.1   | Brazil          | Country      | 1.2
</span></span></span><span class=line><span class=cl><span class=go> 1.2.1.1 | Brasilia        | City         | 1.2.1
</span></span></span><span class=line><span class=cl><span class=go> 1.2.2   | Bahia           | State        | 1.2
</span></span></span><span class=line><span class=cl><span class=go> 1.2.2.1 | Salvador        | City         | 1.2.2
</span></span></span><span class=line><span class=cl><span class=go> 1.3     | Antarctica      | Continent    | 1
</span></span></span><span class=line><span class=cl><span class=go> 1.3.1   | McMurdo Station | City         | 1.3
</span></span></span><span class=line><span class=cl><span class=go> 2.1.1   | unknown         | State        | 2.1
</span></span></span><span class=line><span class=cl><span class=go>(14 rows)
</span></span></span></code></pre></div><p>Least but not last, the search for child nodes from a given node is possible thanks to
specialized comparison operators. To improve performance, it is recommended to create a
GIST index on the primary key column <code>id</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=n>GIST</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>All cities in Europe can be retrieved with the following query.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>l1</span><span class=p>.</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=n>l1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>JOIN</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=n>l2</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>l1</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>&lt;@</span><span class=w> </span><span class=n>l2</span><span class=p>.</span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>l1</span><span class=p>.</span><span class=n>locationtype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>l2</span><span class=p>.</span><span class=k>location</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Europe&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>   id    | location | locationtype
</span></span></span><span class=line><span class=cl><span class=go>---------+----------+--------------
</span></span></span><span class=line><span class=cl><span class=go> 1.1.1.1 | Paris    | City
</span></span></span><span class=line><span class=cl><span class=go> 1.1.2.1 | Madrid   | City
</span></span></span><span class=line><span class=cl><span class=go>(2 rows)
</span></span></span></code></pre></div><hr><h2 id=working-under-constraints>Working under constraints</h2><p>The declared primary key constraint prevents me from inserting an existing path. However, it
is still possible to add a new row whose path does not have any ancestor in the table.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;2.1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Unknown&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Continent&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>INSERT 0 1
</span></span></span></code></pre></div><p>Things does not change much between SQL Server and PostgreSQL, it is necessary to add an
<a href=https://learn.microsoft.com/en-us/sql/relational-databases/hierarchical-data-sql-server#enforce-a-tree target=_blank rel=noopener>additional column</a>, named <code>parentid</code> for instance, to enforce the foreign key constraint.
The following query reuses the <code>subpath()</code> function ensuring a null value is inserted if it
is a root node.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>DELETE</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;@</span><span class=w> </span><span class=s1>&#39;2&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=n>parentid</span><span class=w> </span><span class=n>ltree</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>GENERATED</span><span class=w> </span><span class=n>ALWAYS</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>CASE</span><span class=w> </span><span class=n>subpath</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>nlevel</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>WHEN</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=k>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>ELSE</span><span class=w> </span><span class=n>subpath</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>nlevel</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>END</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=n>STORED</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>By now, whenever a new row is inserted, the foreign key constraint is automatically checked.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;2.1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Unknown&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Continent&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>ERROR:  insert or update on table &#34;locations&#34; violates
</span></span></span><span class=line><span class=cl><span class=go>        foreign key constraint &#34;locations_parentid_fkey&#34;
</span></span></span><span class=line><span class=cl><span class=go>DETAIL:  Key (parentid)=(2.1) is not present in table &#34;locations&#34;.
</span></span></span></code></pre></div><hr><h2 id=just-one-solution-among-others>Just one solution among others</h2><p>This kind of data type is a clever solution to store hierarchical data and is easily
available with PostgreSQL. However, it is an extension of the SQL language and each
database engine can propose an implementation that can radically change from one system
to another.</p><p>As I mentioned in the introduction, the universal answer is to rebuild a hierarchical
relationship using a recursive query and the <code>WITH RECURSIVE</code> syntax. To take the example
of the <code>locations</code> table, the list of cities in Europe could be obtained as follows.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=k>RECURSIVE</span><span class=w> </span><span class=n>loc</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>parentid</span><span class=p>,</span><span class=w> </span><span class=k>location</span><span class=p>,</span><span class=w> </span><span class=n>locationtype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>WHERE</span><span class=w> </span><span class=k>location</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Europe&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>parentid</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=k>location</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>locationtype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=n>l</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>JOIN</span><span class=w> </span><span class=n>loc</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>parentid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>loc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>locationtype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go> id | parentid | location | locationtype
</span></span></span><span class=line><span class=cl><span class=go>----+----------+----------+--------------
</span></span></span><span class=line><span class=cl><span class=go>  4 |        3 | Paris    | City
</span></span></span><span class=line><span class=cl><span class=go>  6 |        5 | Madrid   | City
</span></span></span><span class=line><span class=cl><span class=go>(2 rows)
</span></span></span></code></pre></div></article><aside class=related><h3>Suggested posts</h3><ul class=related-posts><li><a href=https://fljd.in/en/2024/12/17/window-functions-to-the-rescue/>Window functions to the rescue
<small><time datetime=2024-12-17>17 dec 2024</time></small></a></li><li><a href=https://fljd.in/en/2024/11/25/substituting-a-variable-in-a-sql-script/>Substituting a variable in a SQL script
<small><time datetime=2024-11-25>25 nov 2024</time></small></a></li><li><a href=https://fljd.in/en/2024/05/28/an-assistant-to-copy-data-from-a-remote-server/>An assistant to copy data from a remote server
<small><time datetime=2024-05-28>28 may 2024</time></small></a></li></ul></aside></main><footer class=footer><small>&copy; 2019-<time datetime=2025-03-28>2025</time>
— <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.fr>Creative Commons License BY-NC-ND 4.0</a></small></footer></div></body></html>