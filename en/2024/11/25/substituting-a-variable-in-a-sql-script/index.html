<!doctype html><html lang=en><head><title>Substituting a variable in a SQL script</title>
<link rel=stylesheet href=https://fljd.in/css/main.min.css><link rel=apple-touch-icon sizes=180x180 href=/ico/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/ico/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/ico/favicon-16x16.png><link rel=manifest href=/ico/site.webmanifest><meta name=fediverse:creator content="@fljdin@mastodon.tedomum.net"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8></head><body><div class="container content"><header class=homepage><h3 class=homepage-title><a href=/en title="Florent Jardin">Florent Jardin</a>
<small><a href=/index.xml><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#rss"/></svg></a>
<a href=https://mastodon.tedomum.net/@fljdin rel=me><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#mastodon"/></svg></a>
<a href=https://github.com/fljdin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#github"/></svg></a>
<a href=https://www.linkedin.com/in/florent-jardin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#linkedin"/></svg></a>
&nbsp;&nbsp;<a href=/en/talks>Talks</a>&nbsp;&nbsp;<a href=/en/archives>Archives</a>&nbsp;&nbsp;<a href=/en/about>About me</a></small></h3></header><main><article class=post><h1 class=post-title>Substituting a variable in a SQL script</a></h1><p class=post-date><time datetime=2024-11-25>25 nov 2024</time>
- 10 minutes to read</p><div class="message translation">Cet article est disponible en Français : <a href=https://fljd.in/2024/11/25/substituer-une-variable-dans-un-script-sql/>Substituer une variable dans un script SQL</a>
<small>(2024-11-25)</small></div><p>In a world where we constantly seek to automate repetitive tasks, it is common
to write down a query in a script, make it more convenient, and eventually
integrate the whole thing into a project&rsquo;s codebase. Tools like SQL*Plus and
psql can be powerful allies in this game, as relevant as Bash or Python
interpreters.</p><p>In several projects I have been involved in, I have come across a large number
of those kinds of scripts. Some of them have the particularity of offering input
parameters, processed by SQL*Plus with the very comfortable mechanism named
variable substitution. In this article, I share some tips to convert them to an
equivalent syntax that PostgreSQL&rsquo;s psql tool can parse and manage.</p><hr><h2 id=substituting-a-variable>Substituting a variable&mldr;</h2><p>As a starting point, let&rsquo;s look at the syntax supported by Oracle&rsquo;s tool with a
progressive example. We stand in the shoes of a user who wants to get the result
of sales from a dummy company, applying two filters based on a product
identifier and two dates passed as parameters.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- sqlplus-report-01.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CONNECT</span><span class=w> </span><span class=k>user</span><span class=o>/</span><span class=n>password</span><span class=o>@</span><span class=k>database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>start_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;2&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>end_date</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>NVL</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>JOIN</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=p>(</span><span class=n>product_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;start_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>AND</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;end_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>QUIT</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sqlplus -S /nolog @sqlplus-report-01.sql <span class=m>20</span> 2024-11-01 2024-11-30
</span></span><span class=line><span class=cl><span class=go>old   3:  WHERE product_id = &amp;product_id
</span></span></span><span class=line><span class=cl><span class=go>new   3:  WHERE product_id = 20
</span></span></span><span class=line><span class=cl><span class=go>old   4:    AND order_date BETWEEN TO_DATE(&#39;&amp;start_date&#39;, &#39;YYYY-MM-DD&#39;)
</span></span></span><span class=line><span class=cl><span class=go>new   4:    AND order_date BETWEEN TO_DATE(&#39;2024-11-01&#39;, &#39;YYYY-MM-DD&#39;)
</span></span></span><span class=line><span class=cl><span class=go>old   5:		      AND TO_DATE(&#39;&amp;end_date&#39;, &#39;YYYY-MM-DD&#39;)
</span></span></span><span class=line><span class=cl><span class=go>new   5:		      AND TO_DATE(&#39;2024-11-30&#39;, &#39;YYYY-MM-DD&#39;)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>TOTAL_AMOUNT
</span></span></span><span class=line><span class=cl><span class=go>------------
</span></span></span><span class=line><span class=cl><span class=go>     1378.98
</span></span></span></code></pre></div><p>As shown above, the substitution takes place in SQL*Plus as soon as the <code>&</code>
symbol is encountered, whether its content is surrounded by single quotes or
not. At the beginning of the script, I applied a simple strategy by defining
each variable with a meaningful name, to facilitate the readability and
maintenance of the script. We don&rsquo;t want to rely on variables named according to
their position in the list of arguments.</p><hr><p>psql can provide a similar feature, but the syntax is slightly different. We
have to <a href=https://psql-tips.org/psql_tips_all.html#tip037 target=_blank rel=noopener>assign</a> variables outside the script, using the <code>-v</code> or <code>--set</code>
option. These variables will then be substituted in the script using the
<a href=https://www.postgresql.org/docs/current/app-psql.html#APP-PSQL-INTERPOLATION target=_blank rel=noopener>interpolation</a> system.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- psql-report-01.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>\</span><span class=n>pset</span><span class=w> </span><span class=n>footer</span><span class=w> </span><span class=k>off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>JOIN</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=p>(</span><span class=n>product_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>AND</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;end_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f psql-report-01.sql <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>product_id</span><span class=o>=</span><span class=m>20</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>start_date</span><span class=o>=</span><span class=s1>&#39;2024-11-01&#39;</span> -v <span class=nv>end_date</span><span class=o>=</span><span class=s1>&#39;2024-11-30&#39;</span>
</span></span><span class=line><span class=cl><span class=go> total_amount 
</span></span></span><span class=line><span class=cl><span class=go>--------------
</span></span></span><span class=line><span class=cl><span class=go>      1378.98
</span></span></span></code></pre></div><p>From this point, we can see that the conversion is quite straightforward. The
substitution syntax is similar with the <code>:</code> character instead of <code>&</code>. However,
if the variable states as a literal string, we must use the <code>:</code> character
outside the quotes and not inside.</p><hr><h2 id=-in-an-anonymous-block>&mldr; in an anonymous block</h2><p>Things get complicated when the script becomes more complex and requires us to
manipulate our previous variables in an anonymous PL/SQL block. Let&rsquo;s take our
script back to enhance it with a personalized message if the requested product
does not exist. A first read on the <code>products</code> table should eventually raise the
<code>NO_DATA_FOUND</code> exception that we want to catch.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- sqlplus-report-02.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CONNECT</span><span class=w> </span><span class=k>user</span><span class=o>/</span><span class=n>password</span><span class=o>@</span><span class=k>database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>start_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;2&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>end_date</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>serveroutput</span><span class=w> </span><span class=k>ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>feedback</span><span class=w> </span><span class=k>OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>verify</span><span class=w> </span><span class=k>OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_id</span><span class=w>    </span><span class=n>products</span><span class=p>.</span><span class=n>product_id</span><span class=o>%</span><span class=k>TYPE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_sum</span><span class=w>   </span><span class=nb>NUMBER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_start</span><span class=w> </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;start_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_end</span><span class=w>   </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;end_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>NVL</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_sum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>p_end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>DBMS_OUTPUT</span><span class=p>.</span><span class=n>PUT_LINE</span><span class=p>(</span><span class=s1>&#39;Total amount: &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>p_sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>WHEN</span><span class=w> </span><span class=n>NO_DATA_FOUND</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DBMS_OUTPUT</span><span class=p>.</span><span class=n>PUT_LINE</span><span class=p>(</span><span class=s1>&#39;Product &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>&amp;</span><span class=n>product_id</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; does not exist&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>QUIT</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sqlplus -S /nolog @sqlplus-report-02.sql <span class=m>120</span> 2024-11-01 2024-11-30
</span></span><span class=line><span class=cl><span class=go>Product 120 does not exist
</span></span></span></code></pre></div><hr><p>Unfortunately, our beloved psql command-line interface does not support the
ubstitution of variables in an anonymous block and any attempt to do so will
result in a syntax error.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- psql-report-02-wrong.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DO</span><span class=w> </span><span class=err>$$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_id</span><span class=w>    </span><span class=n>products</span><span class=p>.</span><span class=n>product_id</span><span class=o>%</span><span class=k>TYPE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_sum</span><span class=w>   </span><span class=nb>numeric</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_start</span><span class=w> </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_end</span><span class=w>   </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;end_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=k>STRICT</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_sum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>p_end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Total amount: %&#39;</span><span class=p>,</span><span class=w> </span><span class=n>p_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>WHEN</span><span class=w> </span><span class=n>no_data_found</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Product % does not exist&#39;</span><span class=p>,</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>$$</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f psql-report-02-wrong.sql <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>product_id</span><span class=o>=</span><span class=m>120</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>start_date</span><span class=o>=</span><span class=s1>&#39;2024-11-01&#39;</span> -v <span class=nv>end_date</span><span class=o>=</span><span class=s1>&#39;2024-11-30&#39;</span>
</span></span><span class=line><span class=cl><span class=go>psql:psql-report-02-wrong.sql:25: ERROR:  syntax error at or near &#34;:&#34;
</span></span></span><span class=line><span class=cl><span class=go>LINE 5:   p_start date := :&#39;start_date&#39;::date;
</span></span></span><span class=line><span class=cl><span class=go>                          ^
</span></span></span></code></pre></div><p>Do not panic! psql provides us with a way to achieve the same result, with a
deeper rewrite of the script. We will use the <code>\gset</code> meta-command to store the
product state and then the <code>\if</code> meta-command to perform the control.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- psql-report-02.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>\</span><span class=n>pset</span><span class=w> </span><span class=n>footer</span><span class=w> </span><span class=k>off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>unknown_product</span><span class=w> </span><span class=err>\</span><span class=n>gset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>\</span><span class=k>if</span><span class=w> </span><span class=p>:</span><span class=n>unknown_product</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>\</span><span class=n>echo</span><span class=w> </span><span class=s1>&#39;Product&#39;</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w> </span><span class=s1>&#39;does not exist&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>\</span><span class=n>quit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>\</span><span class=n>endif</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>JOIN</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=p>(</span><span class=n>product_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>AND</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;end_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f report.sql <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>product_id</span><span class=o>=</span><span class=m>120</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>start_date</span><span class=o>=</span><span class=s1>&#39;2024-11-01&#39;</span> -v <span class=nv>end_date</span><span class=o>=</span><span class=s1>&#39;2024-11-30&#39;</span>
</span></span><span class=line><span class=cl><span class=go>Product 120 does not exist
</span></span></span></code></pre></div><hr><h2 id=-at-any-costs>&mldr; at any costs</h2><p>In the wild, it may happen that psql meta-commands are not enough to handle all
the intricacies (and absurdities) that SQL*Plus-compatible scripts can present.
Let&rsquo;s move on with a more complex need we want to address.</p><p>Our user now wants to get a performance score for the sales period of his
product, comparing it with the previous period. We would need a cursor here to
reuse the same sales calculation query multiple times and a function to compute
a score by handling the possible division by zero.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- sqlplus-report-03.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CONNECT</span><span class=w> </span><span class=k>user</span><span class=o>/</span><span class=n>password</span><span class=o>@</span><span class=k>database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>start_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;2&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>end_date</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>serveroutput</span><span class=w> </span><span class=k>ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>feedback</span><span class=w> </span><span class=k>OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>verify</span><span class=w> </span><span class=k>OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_id</span><span class=w>         </span><span class=n>products</span><span class=p>.</span><span class=n>product_id</span><span class=o>%</span><span class=k>TYPE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_sum</span><span class=w>        </span><span class=nb>NUMBER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_sum</span><span class=w>   </span><span class=nb>NUMBER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_start</span><span class=w>      </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;start_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_end</span><span class=w>        </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;end_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_start</span><span class=w> </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>(</span><span class=n>p_end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>p_start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_end</span><span class=w>   </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CURSOR</span><span class=w> </span><span class=n>c_orders</span><span class=w> </span><span class=p>(</span><span class=n>v_start</span><span class=w> </span><span class=nb>DATE</span><span class=p>,</span><span class=w> </span><span class=n>v_end</span><span class=w> </span><span class=nb>DATE</span><span class=p>)</span><span class=w> </span><span class=k>IS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>v_start</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>v_end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FUNCTION</span><span class=w> </span><span class=n>score</span><span class=p>(</span><span class=n>p_sum</span><span class=w> </span><span class=nb>NUMBER</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=nb>NUMBER</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>RETURN</span><span class=w> </span><span class=nb>NUMBER</span><span class=w> </span><span class=k>IS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>v_score</span><span class=w> </span><span class=nb>NUMBER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>RETURN</span><span class=w> </span><span class=n>ROUND</span><span class=p>((</span><span class=n>p_sum</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHEN</span><span class=w> </span><span class=n>ZERO_DIVIDE</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>RETURN</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>OPEN</span><span class=w> </span><span class=n>c_orders</span><span class=p>(</span><span class=n>p_start</span><span class=p>,</span><span class=w> </span><span class=n>p_end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FETCH</span><span class=w> </span><span class=n>c_orders</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CLOSE</span><span class=w> </span><span class=n>c_orders</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>OPEN</span><span class=w> </span><span class=n>c_orders</span><span class=p>(</span><span class=n>p_prev_start</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FETCH</span><span class=w> </span><span class=n>c_orders</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CLOSE</span><span class=w> </span><span class=n>c_orders</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>DBMS_OUTPUT</span><span class=p>.</span><span class=n>PUT_LINE</span><span class=p>(</span><span class=s1>&#39;Total amount: &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>p_sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>DBMS_OUTPUT</span><span class=p>.</span><span class=n>PUT_LINE</span><span class=p>(</span><span class=s1>&#39;Performance score: &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>score</span><span class=p>(</span><span class=n>p_sum</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>WHEN</span><span class=w> </span><span class=n>NO_DATA_FOUND</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DBMS_OUTPUT</span><span class=p>.</span><span class=n>PUT_LINE</span><span class=p>(</span><span class=s1>&#39;Product &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>&amp;</span><span class=n>product_id</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; does not exist&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>QUIT</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sqlplus -S /nolog @sqlplus-report-03.sql <span class=m>20</span> 2024-11-01 2024-11-30
</span></span><span class=line><span class=cl><span class=go>Total amount: 1378.98
</span></span></span><span class=line><span class=cl><span class=go>Performance score: 162.99
</span></span></span></code></pre></div><p>Of course, the example is deliberately simplistic and could be addressed by a
<a href=/en/2024/12/17/window-functions-to-the-rescue/>window function</a>, but we will play the game of converting the script as
close as possible to its original syntax. To do this, let&rsquo;s identify the
weaknesses of PL/pgSQL.</p><hr><p><strong>Temporary routines are not supported</strong></p><p>PL/pgSQL language does not allow the declaration of stored functions or storeed
procedures inside an anonymous block. The only alternative is to define it
globally, so that it is known to the parser and executed correctly. In this
present case, I do not want the function to persist after the call of my script.
No problem, we can create a temporary function in the <code>pg_temp</code> schema!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- temp-function.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DO</span><span class=w> </span><span class=err>$$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CREATE</span><span class=w> </span><span class=k>FUNCTION</span><span class=w> </span><span class=n>pg_temp</span><span class=p>.</span><span class=n>score</span><span class=p>(</span><span class=n>p_sum</span><span class=w> </span><span class=nb>numeric</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=nb>numeric</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>RETURNS</span><span class=w> </span><span class=nb>numeric</span><span class=w> </span><span class=k>LANGUAGE</span><span class=w> </span><span class=n>plpgsql</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=err>$</span><span class=n>func$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>RETURN</span><span class=w> </span><span class=n>ROUND</span><span class=p>((</span><span class=n>p_sum</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>WHEN</span><span class=w> </span><span class=n>division_by_zero</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>RETURN</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>$</span><span class=n>func$</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Score: %&#39;</span><span class=p>,</span><span class=w> </span><span class=n>pg_temp</span><span class=p>.</span><span class=n>score</span><span class=p>(</span><span class=mi>100</span><span class=p>.</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>50</span><span class=p>.</span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Score: %&#39;</span><span class=p>,</span><span class=w> </span><span class=n>pg_temp</span><span class=p>.</span><span class=n>score</span><span class=p>(</span><span class=mi>100</span><span class=p>.</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>$$</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f temp-function.sql
</span></span><span class=line><span class=cl><span class=go>psql:temp-function.sql:16: NOTICE:  Score: 100.00
</span></span></span><span class=line><span class=cl><span class=go>psql:temp-function.sql:16: NOTICE:  Score: &lt;NULL&gt;
</span></span></span><span class=line><span class=cl><span class=go>DO
</span></span></span></code></pre></div><p>The <code>pg_temp.score(numeric, numeric)</code> function is now accessible within the
block, and only for the duration of the session. Exception handling respects the
expressed need. We just had to replace <code>ZERO_DIVIDE</code> with <code>division_by_zero</code> as
describe in the <a href=https://www.postgresql.org/docs/current/errcodes-appendix.html target=_blank rel=noopener>documentation</a>.</p><p><strong>SQL substitution is not supported</strong></p><p>Our main issue strikes back: substitution does not occur when we are in a
PL/pgSQL block. To work around this limitation, we will have to use the <a href=https://www.postgresql.org/docs/current/runtime-config-custom.html target=_blank rel=noopener>custom
session variables</a> made available for the PostgreSQL extension ecosystem.</p><p>Those variables can be manipulated as well in psql with the <code>SET</code> keyword as in
SQL or PL/pgSQL with the <a href=https://pgpedia.info/c/current_setting.html target=_blank rel=noopener><code>current_setting</code></a> and <a href=https://pgpedia.info/s/set_config.html target=_blank rel=noopener><code>set_config</code></a> functions.
The only constraint is to define a prefix that does not conflict with that of
other variables already declared in our instance.</p><p>It means that our parameters can be set as session variables in the very
beginning of the script. As soon as we are in an anonymous block, we must then
assign them back to regular variables as shown in the following code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>start_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>start_date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>end_date</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>end_date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DO</span><span class=w> </span><span class=err>$$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>my_id</span><span class=w>   </span><span class=nb>int</span><span class=w>  </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.product_id&#39;</span><span class=p>)::</span><span class=nb>int</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_start</span><span class=w> </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.start_date&#39;</span><span class=p>)::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_end</span><span class=w>   </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.end_date&#39;</span><span class=p>)::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>$$</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p><strong>Full conversion</strong></p><p>A new version of the script, converted from PL/SQL to PL/pgSQL, can be obtained
with all previous tricks put together:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- psql-report-03.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>\</span><span class=k>set</span><span class=w> </span><span class=n>QUIET</span><span class=w> </span><span class=k>on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>start_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>end_date</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;end_date&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DO</span><span class=w> </span><span class=err>$$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>my_id</span><span class=w>        </span><span class=nb>int</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.product_id&#39;</span><span class=p>)::</span><span class=nb>int</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_id</span><span class=w>         </span><span class=n>products</span><span class=p>.</span><span class=n>product_id</span><span class=o>%</span><span class=k>TYPE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_sum</span><span class=w>        </span><span class=nb>numeric</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_sum</span><span class=w>   </span><span class=nb>numeric</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_start</span><span class=w>      </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.start_date&#39;</span><span class=p>)::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_end</span><span class=w>        </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.end_date&#39;</span><span class=p>)::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_start</span><span class=w> </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1 day&#39;</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>p_end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>p_start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_end</span><span class=w>   </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1 day&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>c_orders</span><span class=w> </span><span class=k>CURSOR</span><span class=w> </span><span class=p>(</span><span class=n>v_start</span><span class=w> </span><span class=nb>date</span><span class=p>,</span><span class=w> </span><span class=n>v_end</span><span class=w> </span><span class=nb>date</span><span class=p>)</span><span class=w> </span><span class=k>IS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>v_start</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>v_end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CREATE</span><span class=w> </span><span class=k>FUNCTION</span><span class=w> </span><span class=n>pg_temp</span><span class=p>.</span><span class=n>score</span><span class=p>(</span><span class=n>p_sum</span><span class=w> </span><span class=nb>numeric</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=nb>numeric</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>RETURNS</span><span class=w> </span><span class=nb>numeric</span><span class=w> </span><span class=k>LANGUAGE</span><span class=w> </span><span class=n>plpgsql</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=err>$</span><span class=n>func$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>RETURN</span><span class=w> </span><span class=n>ROUND</span><span class=p>((</span><span class=n>p_sum</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>WHEN</span><span class=w> </span><span class=n>division_by_zero</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>RETURN</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>$</span><span class=n>func$</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=k>STRICT</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>my_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>OPEN</span><span class=w> </span><span class=n>c_orders</span><span class=p>(</span><span class=n>p_start</span><span class=p>,</span><span class=w> </span><span class=n>p_end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FETCH</span><span class=w> </span><span class=n>c_orders</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CLOSE</span><span class=w> </span><span class=n>c_orders</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>OPEN</span><span class=w> </span><span class=n>c_orders</span><span class=p>(</span><span class=n>p_prev_start</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FETCH</span><span class=w> </span><span class=n>c_orders</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CLOSE</span><span class=w> </span><span class=n>c_orders</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Total amount: %&#39;</span><span class=p>,</span><span class=w> </span><span class=n>p_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Performance score: %&#39;</span><span class=p>,</span><span class=w> </span><span class=n>pg_temp</span><span class=p>.</span><span class=n>score</span><span class=p>(</span><span class=n>p_sum</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>WHEN</span><span class=w> </span><span class=n>no_data_found</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Product % does not exist&#39;</span><span class=p>,</span><span class=w> </span><span class=n>my_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>$$</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f psql-report-03.sql<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>product_id</span><span class=o>=</span><span class=m>20</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>start_date</span><span class=o>=</span><span class=s1>&#39;2024-11-01&#39;</span> -v <span class=nv>end_date</span><span class=o>=</span><span class=s1>&#39;2024-11-30&#39;</span> 
</span></span><span class=line><span class=cl><span class=go>psql:psql-report-03.sql:55: NOTICE:  Total amount: 1378.98
</span></span></span><span class=line><span class=cl><span class=go>psql:psql-report-03.sql:55: NOTICE:  Performance score: 162.99
</span></span></span></code></pre></div><hr><h2 id=conclusion>Conclusion</h2><p>This kind of rewriting becomes affordable when we know the right tricks, without
losing sight of the initial goal. Of course, a one-to-one translation, by
preserving the syntax and the original intent, could be more challenging than
that blog post example.</p><p>I&rsquo;m a bit skeptical about those who want to keep such development practices.
They seem outdated to me. Isn&rsquo;t migrating to PostgreSQL an opportunity to
modernize our codebase or to question our relationship with technology? In our
example, as I previously mentioned, it is possible to get the same result in a
single SQL, combining meta-commands, variables substitution, common-table
expressions, and a the <code>LAG</code> window function.</p><p>In that way, we throw away the PL/pgSQL block and its limitations.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- psql-report-04.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>\</span><span class=n>pset</span><span class=w> </span><span class=n>footer</span><span class=w> </span><span class=k>off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>unknown_product</span><span class=w> </span><span class=err>\</span><span class=n>gset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>\</span><span class=k>if</span><span class=w> </span><span class=p>:</span><span class=n>unknown_product</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>\</span><span class=n>echo</span><span class=w> </span><span class=s1>&#39;Product&#39;</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w> </span><span class=s1>&#39;does not exist&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>\</span><span class=n>quit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>\</span><span class=n>endif</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;end_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>days</span><span class=w> </span><span class=err>\</span><span class=n>gset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>:</span><span class=n>days</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>prev_start</span><span class=w> </span><span class=err>\</span><span class=n>gset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WITH</span><span class=w> </span><span class=n>periods</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>start_date</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>:</span><span class=n>days</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s1>&#39;1 day&#39;</span><span class=p>::</span><span class=nb>interval</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>end_date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>generate_series</span><span class=p>(:</span><span class=s1>&#39;prev_start&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=p>:</span><span class=n>days</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s1>&#39;1 day&#39;</span><span class=p>::</span><span class=nb>interval</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>s</span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>),</span><span class=w> </span><span class=n>amounts</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>start_date</span><span class=p>,</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_amount</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>LAG</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>start_date</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>prev_total_amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>JOIN</span><span class=w> </span><span class=n>periods</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>start_date</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>end_date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>start_date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>total_amount</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>ROUND</span><span class=p>((</span><span class=n>total_amount</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>prev_total_amount</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>prev_total_amount</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>performance_score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>amounts</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>prev_total_amount</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f psql-report-04.sql<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>product_id</span><span class=o>=</span><span class=m>20</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>start_date</span><span class=o>=</span><span class=s1>&#39;2024-11-01&#39;</span> -v <span class=nv>end_date</span><span class=o>=</span><span class=s1>&#39;2024-11-30&#39;</span> 
</span></span><span class=line><span class=cl><span class=go> total_amount | performance_score 
</span></span></span><span class=line><span class=cl><span class=go>--------------+-------------------
</span></span></span><span class=line><span class=cl><span class=go>      1378.98 |            162.99 
</span></span></span></code></pre></div><div class=message>You can find all the scripts of this article, as well as the DDL commands to
the data model, at this <a href=https://gist.github.com/fljdin/45d9ece1c9aba054c85cfbede09c95fd target=_blank rel=noopener>address</a>.</div></article><aside class=related><h3>Suggested posts</h3><ul class=related-posts><li><a href=https://fljd.in/en/2024/05/28/an-assistant-to-copy-data-from-a-remote-server/>An assistant to copy data from a remote server
<small><time datetime=2024-05-28>28 may 2024</time></small></a></li><li><a href=https://fljd.in/en/2024/12/17/window-functions-to-the-rescue/>Window functions to the rescue
<small><time datetime=2024-12-17>17 dec 2024</time></small></a></li><li><a href=https://fljd.in/en/2024/09/19/hierarchical-data-types/>Hierarchical data types
<small><time datetime=2024-09-19>19 sep 2024</time></small></a></li></ul></aside></main><footer class=footer><small>&copy; 2019-<time datetime=2025-06-11>2025</time>
— <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.fr>Creative Commons License BY-NC-ND 4.0</a></small></footer></div></body></html>