<!doctype html><html lang=en><head><title>Window functions to the rescue</title>
<link rel=stylesheet href=https://fljd.in/css/main.min.css><link rel=apple-touch-icon sizes=180x180 href=/ico/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/ico/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/ico/favicon-16x16.png><link rel=manifest href=/ico/site.webmanifest><meta name=fediverse:creator content="@fljdin@mastodon.tedomum.net"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8></head><body><div class="container content"><header class=homepage><h3 class=homepage-title><a href=/en title="Florent Jardin">Florent Jardin</a>
<small><a href=/index.xml><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#rss"/></svg></a>
<a href=https://mastodon.tedomum.net/@fljdin rel=me><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#mastodon"/></svg></a>
<a href=https://github.com/fljdin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#github"/></svg></a>
<a href=https://www.linkedin.com/in/florent-jardin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#linkedin"/></svg></a>
&nbsp;&nbsp;<a href=/en/talks>Talks</a>&nbsp;&nbsp;<a href=/en/archives>Archives</a>&nbsp;&nbsp;<a href=/en/about>About me</a></small></h3></header><main><article class=post><h1 class=post-title>Window functions to the rescue</a></h1><p class=post-date><time datetime=2024-12-17>17 dec 2024</time>
- 5 minutes to read</p><div class="message translation">Cet article est disponible en Français : <a href=https://fljd.in/2023/02/10/le-fenetrage-a-la-rescousse/>Le fenêtrage à la rescousse</a>
<small>(2023-02-10)</small></div><p>PostgreSQL comes with a variety of functions that allow you to group rows into a
&ldquo;window&rdquo; and perform calculations on that window. By using these functions, you
can create more advanced and efficient queries for analyzing your database.</p><p>In early 2023, I contributed to a project that converts data models to
PostgreSQL, called <a href=https://github.com/cybertec-postgresql/db_migrator target=_blank rel=noopener>db_migrator</a>. On this occasion, I (re)discovered the
power of these <a href=https://www.postgresql.org/docs/current/functions-window.html target=_blank rel=noopener>window functions</a> with the SQL language. In this article, I
revisit a <a href=https://github.com/cybertec-postgresql/db_migrator/pull/11 target=_blank rel=noopener>specific case</a> of transforming the upper bounds of a partitioned
table into an array of boundaries.</p><hr><h2 id=through-a-window>Through a window</h2><p>We do not hide it, the use of a window in a query is (really) not usual.
Windowing is a particularly useful technique for performing time-shifted data
analysis, like cumulative totals, moving averages, trends, etc.</p><p>The most commonly used windowing functions in PostgreSQL are <code>first_value()</code>,
<code>last_value()</code>, <code>rank()</code>, <code>row_number()</code>, and <code>lag()</code>. These functions can be
combined with aggregation functions such as <code>sum()</code>, <code>avg()</code>, <code>count()</code>,
<code>min()</code>, and <code>max()</code> to produce even more useful results.</p><p>Let us see a practical example with the <code>first_value()</code> method that presents the
first line of the window attached to each line. With the concrete case of
partitioning, we want to know the first partition defined for the table for each
line of a table named <code>partitions</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>table_name</span><span class=w> </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>partition_name</span><span class=w> </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>upper_bound</span><span class=w> </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>position</span><span class=w> </span><span class=nb>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;tab&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;less_than_10&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;tab&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;less_than_20&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;20&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;tab&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;less_than_30&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;30&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;tab&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;less_than_40&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;40&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;tab&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;less_than_max&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;MAXVALUE&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>table_name</span><span class=p>,</span><span class=w> </span><span class=n>partition_name</span><span class=p>,</span><span class=w> </span><span class=n>upper_bound</span><span class=p>,</span><span class=w> </span><span class=k>position</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>first_value</span><span class=p>(</span><span class=n>partition_name</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>table_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>position</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>first_partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>partitions</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl> table_name | partition_name | upper_bound | position | first_partition
</span></span><span class=line><span class=cl>------------+----------------+-------------+----------+-----------------
</span></span><span class=line><span class=cl> tab        | less_than_10   | 10          |        1 | less_than_10
</span></span><span class=line><span class=cl> tab        | less_than_20   | 20          |        2 | less_than_10
</span></span><span class=line><span class=cl> tab        | less_than_30   | 30          |        3 | less_than_10
</span></span><span class=line><span class=cl> tab        | less_than_40   | 40          |        4 | less_than_10
</span></span><span class=line><span class=cl> tab        | less_than_max  | MAXVALUE    |        5 | less_than_10
</span></span></code></pre></div><p>A window function is used in conjunction with the <code>OVER</code> clause to specify the
window boundaries, determining column key on which the window function applies.
Here, the window groups the partition data by the table name (<code>table_name</code>) by
sorting them with the <code>ORDER BY</code> clause.</p><p>A window moves for each line, expanding its boundaries according to the new
lines it reads in the declared order. If we want to retrieve the last partition
defined for the table of each line, it is necessary to <strong>reverse the sorting</strong>
of the window, in order to start reading from the bottom up to the current line
and <strong>sort again</strong> the result.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>table_name</span><span class=p>,</span><span class=w> </span><span class=n>partition_name</span><span class=p>,</span><span class=w> </span><span class=n>upper_bound</span><span class=p>,</span><span class=w> </span><span class=k>position</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>first_value</span><span class=p>(</span><span class=n>partition_name</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>table_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>position</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>last_partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>partitions</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>position</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl> table_name | partition_name | upper_bound | position | last_partition
</span></span><span class=line><span class=cl>------------+----------------+-------------+----------+----------------
</span></span><span class=line><span class=cl> tab        | less_than_10   | 10          |        1 | less_than_max
</span></span><span class=line><span class=cl> tab        | less_than_20   | 20          |        2 | less_than_max
</span></span><span class=line><span class=cl> tab        | less_than_30   | 30          |        3 | less_than_max
</span></span><span class=line><span class=cl> tab        | less_than_40   | 40          |        4 | less_than_max
</span></span><span class=line><span class=cl> tab        | less_than_max  | MAXVALUE    |        5 | less_than_max
</span></span></code></pre></div><hr><h2 id=looking-for-the-lower-bound>Looking for the lower bound</h2><p>With Oracle or even MySQL, partitioning by <code>RANGE</code> only requires the upper bound
to be defined to distribute the data into the partitions. Thus, creating a
partitioned table is similar to the following example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>junk</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>RANGE</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=n>less_than_10</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=k>LESS</span><span class=w> </span><span class=k>THAN</span><span class=w> </span><span class=p>(</span><span class=mi>10</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=n>less_than_20</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=k>LESS</span><span class=w> </span><span class=k>THAN</span><span class=w> </span><span class=p>(</span><span class=mi>20</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=n>less_than_30</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=k>LESS</span><span class=w> </span><span class=k>THAN</span><span class=w> </span><span class=p>(</span><span class=mi>30</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=n>less_than_40</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=k>LESS</span><span class=w> </span><span class=k>THAN</span><span class=w> </span><span class=p>(</span><span class=mi>40</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=n>less_than_max</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=k>LESS</span><span class=w> </span><span class=k>THAN</span><span class=w> </span><span class=k>MAXVALUE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>PostgreSQL is slightly more strict on the definition of <code>RANGE</code> partitions with
the use of lower and upper bounds, like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>junk</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>RANGE</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>less_than_10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>OF</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=k>MINVALUE</span><span class=p>)</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=p>(</span><span class=mi>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>less_than_20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>OF</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=p>(</span><span class=mi>20</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>less_than_30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>OF</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=p>(</span><span class=mi>30</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>less_than_40</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>OF</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=mi>30</span><span class=p>)</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=p>(</span><span class=mi>40</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>less_than_max</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PARTITION</span><span class=w> </span><span class=k>OF</span><span class=w> </span><span class=n>tab</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=mi>40</span><span class=p>)</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=p>(</span><span class=k>MAXVALUE</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>We want to build an array of lower and upper bounds from multiple rows of our
previously defined <code>partitions</code> table. The <code>lag()</code> function is the perfect
candidate for this task, as it allows us to access the value of a previous row
in the same window.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>lag (value anycompatible [, offset integer [, default anycompatible ]])
</span></span><span class=line><span class=cl>   → anycompatible
</span></span></code></pre></div><blockquote><p>Returns <code>value</code> evaluated at the row that is <code>offset</code> rows before the current
row within the partition; if there is no such row, instead returns <code>default</code>
(which must be of a type compatible with value).</p></blockquote><p>The new query looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>table_name</span><span class=p>,</span><span class=w> </span><span class=n>partition_name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nb>ARRAY</span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>lag</span><span class=p>(</span><span class=n>upper_bound</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;MINVALUE&#39;</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>table_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>position</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>upper_bound</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>]::</span><span class=nb>text</span><span class=p>[]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>boundaries</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>partitions</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl> table_name | partition_name |  boundaries
</span></span><span class=line><span class=cl>------------+----------------+---------------
</span></span><span class=line><span class=cl> tab        | less_than_10   | {MINVALUE,10}
</span></span><span class=line><span class=cl> tab        | less_than_20   | {10,20}
</span></span><span class=line><span class=cl> tab        | less_than_30   | {20,30}
</span></span><span class=line><span class=cl> tab        | less_than_40   | {30,40}
</span></span><span class=line><span class=cl> tab        | less_than_max  | {40,MAXVALUE}
</span></span></code></pre></div><p>Another query with <code>first_value()</code> had been used before <code>lag()</code> was proposed by
Laurenz Albe in the final form of my work. For an equivalent result, it was
considered less suitable by relying unnecessarily on more advanced clauses such
as <code>RANGE BETWEEN</code> and <code>EXCLUDE</code>. I let you appreciate the full syntax.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>table_name</span><span class=p>,</span><span class=w> </span><span class=n>partition_name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nb>ARRAY</span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>coalesce</span><span class=p>(</span><span class=n>first_value</span><span class=p>(</span><span class=n>upper_bound</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>table_name</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>position</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>RANGE</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>PRECEDING</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>CURRENT</span><span class=w> </span><span class=k>ROW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>EXCLUDE</span><span class=w> </span><span class=k>CURRENT</span><span class=w> </span><span class=k>ROW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>),</span><span class=w> </span><span class=s1>&#39;MINVALUE&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>upper_bound</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>]::</span><span class=nb>text</span><span class=p>[]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>boundaries</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>partitions</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><hr><h2 id=conclusion>Conclusion</h2><p>Windowing is not a easy concept to grasp, especially since concrete and relevant
cases are not encountered frequently. Without mastering its subtleties, it is
useful to know its purpose, or at least its existence. It would have been
tempting to make joins, CTEs, or subqueries but at the cost of reduced
readability and potential optimization barriers.</p></article><aside class=related><h3>Suggested posts</h3><ul class=related-posts><li><a href=https://fljd.in/en/2024/11/25/substituting-a-variable-in-a-sql-script/>Substituting a variable in a SQL script
<small><time datetime=2024-11-25>25 nov 2024</time></small></a></li><li><a href=https://fljd.in/en/2024/09/19/hierarchical-data-types/>Hierarchical data types
<small><time datetime=2024-09-19>19 sep 2024</time></small></a></li><li><a href=https://fljd.in/en/2024/05/28/an-assistant-to-copy-data-from-a-remote-server/>An assistant to copy data from a remote server
<small><time datetime=2024-05-28>28 may 2024</time></small></a></li></ul></aside></main><footer class=footer><small>&copy; 2019-<time datetime=2025-05-18>2025</time>
— <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.fr>Creative Commons License BY-NC-ND 4.0</a></small></footer></div></body></html>