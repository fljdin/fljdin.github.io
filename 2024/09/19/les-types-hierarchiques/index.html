<!doctype html><html lang=fr><head><title>Les types hiérarchiques</title>
<link rel=stylesheet href=https://fljd.in/css/main.min.css><link rel=apple-touch-icon sizes=180x180 href=/ico/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/ico/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/ico/favicon-16x16.png><link rel=manifest href=/ico/site.webmanifest><meta name=fediverse:creator content="@fljdin@mastodon.tedomum.net"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8></head><body><div class="container content"><header class=homepage><h3 class=homepage-title><a href=/ title="Florent Jardin">Florent Jardin</a>
<small><a href=/index.xml><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#rss"/></svg></a>
<a href=https://mastodon.tedomum.net/@fljdin rel=me><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#mastodon"/></svg></a>
<a href=https://github.com/fljdin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#github"/></svg></a>
<a href=https://www.linkedin.com/in/florent-jardin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#linkedin"/></svg></a>
&nbsp;&nbsp;<a href=/conferences>Conférences</a>&nbsp;&nbsp;<a href=/archives>Archives</a>&nbsp;&nbsp;<a href=/a-propos>À propos</a></small></h3></header><main><article class=post><h1 class=post-title>Les types hiérarchiques</a></h1><p class=post-date><time datetime=2024-09-19>19 sept 2024</time>
- 6 minutes de lecture</p><div class="message translation">This article is available in English: <a href=https://fljd.in/en/2024/09/19/hierarchical-data-types/>Hierarchical data types</a>
<small>(2024-09-19)</small></div><p>Bien que la norme SQL définisse un ensemble de règles pour que les systèmes de bases
de données puissent être interchangeables, il existe de petites singularités dans la
nature. À ce titre, le type de données <code>hierarchyid</code> fourni par SQL Server est un
exemple flagrant. Si vous êtes amené à basculer vers PostgreSQL, deux solutions s&rsquo;offrent
à vous.</p><p>Une première et plus simple consiste à lier chaque nœud à son parent à l&rsquo;aide d&rsquo;une nouvelle
colonne <code>parentid</code> et d&rsquo;y appliquer une contrainte de clé étrangère. Une autre approche,
plus complète, consiste à utiliser l&rsquo;extension <code>ltree</code>. Cet article traite de ce dernier
cas.</p><hr><h2 id=à-la-recherche-de-ses-descendants>À la recherche de ses descendants</h2><p>Conçu pour représenter une <a href=https://learn.microsoft.com/en-us/sql/relational-databases/hierarchical-data-sql-server target=_blank rel=noopener>relation hiérarchique</a> sous la forme d&rsquo;un arbre binaire, le
type <code>hierarchyid</code> a la particularité de stocker la liste des nœuds successifs jusqu&rsquo;à
la racine dans une seule colonne. Ainsi, le nœud <code>/1/1/2/</code> représente un nœud de niveau
3, enfant du nœud <code>/1/1/</code>, lui-même enfant du nœud <code>/1/</code>, lui-même enfant de la racine <code>/</code>.</p><p>Plusieurs méthodes sont fournies avec le langage Transact-SQL pour manipuler les données et
toutes parcourent l&rsquo;arbre binaire pour en extraire rapidement l&rsquo;information souhaitée sans
avoir à joindre les nœuds de la table entre eux.</p><ul><li><a href=https://learn.microsoft.com/en-us/sql/t-sql/data-types/tostring-database-engine target=_blank rel=noopener><code>ToString()</code></a> : retourne la représentation textuelle du nœud courant.</li><li><a href=https://learn.microsoft.com/en-us/sql/t-sql/data-types/getlevel-database-engine target=_blank rel=noopener><code>GetLevel()</code></a> : retourne le niveau de profondeur du nœud courant.</li><li><a href=https://learn.microsoft.com/en-us/sql/t-sql/data-types/getancestor-database-engine target=_blank rel=noopener><code>GetAncestor(n)</code></a> : retourne le nœud de niveau <code>n</code> dans l&rsquo;arbre.</li><li><a href=https://learn.microsoft.com/en-us/sql/t-sql/data-types/getdescendant-database-engine target=_blank rel=noopener><code>GetDescendant(c1, c2)</code></a> : retourne un nouveau nœud enfant entre deux nœuds.</li></ul><p>L&rsquo;extension <a href=https://www.postgresql.org/docs/current/ltree.html target=_blank rel=noopener>ltree</a>, disponible depuis le paquet <code>contrib</code> de PostgreSQL, est aussi complète,
voire plus, que le type <code>hierarchyid</code>. Elle fournit un type de données complexe, nommé <code>ltree</code>,
et permet de stocker des labels de 1 000 caractères alphanumériques séparés par des points. Le
chemin (<code>path</code>) ainsi constitué, peut lui-même contenir jusqu&rsquo;à 65 635 labels.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=n>EXTENSION</span><span class=w> </span><span class=n>ltree</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=n>ltree</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>location</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>locationtype</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Earth&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Planet&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Europe&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Continent&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;France&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Country&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.1.1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Paris&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.1.2&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Spain&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Country&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.1.2.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Madrid&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.2&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;South-America&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Continent&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.2.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Brazil&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Country&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.2.1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Brasilia&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.2.2&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Bahia&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;State&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.2.2.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Salvador&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.3&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Antarctica&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Continent&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=s1>&#39;1.3.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;McMurdo Station&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Obtenir le niveau de profondeur d&rsquo;un nœud devient trivial avec la fonction <code>nlevel()</code>
fournie par l&rsquo;extension <code>ltree</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=k>location</span><span class=p>,</span><span class=w> </span><span class=n>locationtype</span><span class=p>,</span><span class=w> </span><span class=n>nlevel</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>level</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>   id    |    location     | locationtype | level
</span></span></span><span class=line><span class=cl><span class=go>---------+-----------------+--------------+-------
</span></span></span><span class=line><span class=cl><span class=go> 1       | Earth           | Planet       |     1
</span></span></span><span class=line><span class=cl><span class=go> 1.1     | Europe          | Continent    |     2
</span></span></span><span class=line><span class=cl><span class=go> 1.1.1   | France          | Country      |     3
</span></span></span><span class=line><span class=cl><span class=go> 1.1.1.1 | Paris           | City         |     4
</span></span></span><span class=line><span class=cl><span class=go> 1.1.2   | Spain           | Country      |     3
</span></span></span><span class=line><span class=cl><span class=go> 1.1.2.1 | Madrid          | City         |     4
</span></span></span><span class=line><span class=cl><span class=go> 1.2     | South-America   | Continent    |     2
</span></span></span><span class=line><span class=cl><span class=go> 1.2.1   | Brazil          | Country      |     3
</span></span></span><span class=line><span class=cl><span class=go> 1.2.1.1 | Brasilia        | City         |     4
</span></span></span><span class=line><span class=cl><span class=go> 1.2.2   | Bahia           | State        |     3
</span></span></span><span class=line><span class=cl><span class=go> 1.2.2.1 | Salvador        | City         |     4
</span></span></span><span class=line><span class=cl><span class=go> 1.3     | Antarctica      | Continent    |     2
</span></span></span><span class=line><span class=cl><span class=go> 1.3.1   | McMurdo Station | City         |     3
</span></span></span><span class=line><span class=cl><span class=go> 2.1.1   | unknown         | State        |     3
</span></span></span><span class=line><span class=cl><span class=go>(14 rows)
</span></span></span></code></pre></div><p>Une autre méthode nommée <code>subpath()</code> permet de récupérer une partie du chemin d&rsquo;un nœud.
Voyons comment obtenir le nœud parent de chaque nœud de la table.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=k>location</span><span class=p>,</span><span class=w> </span><span class=n>locationtype</span><span class=p>,</span><span class=w> </span><span class=n>subpath</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>nlevel</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>parentid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>   id    |    location     | locationtype | parent
</span></span></span><span class=line><span class=cl><span class=go>---------+-----------------+--------------+--------
</span></span></span><span class=line><span class=cl><span class=go> 1       | Earth           | Planet       |
</span></span></span><span class=line><span class=cl><span class=go> 1.1     | Europe          | Continent    | 1
</span></span></span><span class=line><span class=cl><span class=go> 1.1.1   | France          | Country      | 1.1
</span></span></span><span class=line><span class=cl><span class=go> 1.1.1.1 | Paris           | City         | 1.1.1
</span></span></span><span class=line><span class=cl><span class=go> 1.1.2   | Spain           | Country      | 1.1
</span></span></span><span class=line><span class=cl><span class=go> 1.1.2.1 | Madrid          | City         | 1.1.2
</span></span></span><span class=line><span class=cl><span class=go> 1.2     | South-America   | Continent    | 1
</span></span></span><span class=line><span class=cl><span class=go> 1.2.1   | Brazil          | Country      | 1.2
</span></span></span><span class=line><span class=cl><span class=go> 1.2.1.1 | Brasilia        | City         | 1.2.1
</span></span></span><span class=line><span class=cl><span class=go> 1.2.2   | Bahia           | State        | 1.2
</span></span></span><span class=line><span class=cl><span class=go> 1.2.2.1 | Salvador        | City         | 1.2.2
</span></span></span><span class=line><span class=cl><span class=go> 1.3     | Antarctica      | Continent    | 1
</span></span></span><span class=line><span class=cl><span class=go> 1.3.1   | McMurdo Station | City         | 1.3
</span></span></span><span class=line><span class=cl><span class=go> 2.1.1   | unknown         | State        | 2.1
</span></span></span><span class=line><span class=cl><span class=go>(14 rows)
</span></span></span></code></pre></div><p>Enfin, la recherche des nœuds enfants depuis un nœud donné est possible grâce aux
opérateurs de comparaison spécialisés. Pour favoriser les performances, il est recommandé
de créer un index GIST sur la colonne de clé primaire <code>id</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=n>GIST</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>La requête suivante liste toutes les villes d&rsquo;Europe.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>l1</span><span class=p>.</span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=n>l1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>JOIN</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=n>l2</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>l1</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>&lt;@</span><span class=w> </span><span class=n>l2</span><span class=p>.</span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>l1</span><span class=p>.</span><span class=n>locationtype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>l2</span><span class=p>.</span><span class=k>location</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Europe&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>   id    | location | locationtype
</span></span></span><span class=line><span class=cl><span class=go>---------+----------+--------------
</span></span></span><span class=line><span class=cl><span class=go> 1.1.1.1 | Paris    | City
</span></span></span><span class=line><span class=cl><span class=go> 1.1.2.1 | Madrid   | City
</span></span></span><span class=line><span class=cl><span class=go>(2 rows)
</span></span></span></code></pre></div><hr><h2 id=travailler-sous-contraintes>Travailler sous contraintes</h2><p>La contrainte de clé primaire m&rsquo;empêche actuellement d&rsquo;insérer un chemin déjà existant.
Par contre, il est bien possible d&rsquo;ajouter une nouvelle ligne dont le chemin ne présente
pas d&rsquo;ancêtre dans la table.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;2.1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Unknown&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Continent&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>INSERT 0 1
</span></span></span></code></pre></div><p>À ce jeu, SQL Server et PostgreSQL n&rsquo;ont plus trop de différences, il devient nécessaire
d&rsquo;ajouter une <a href=https://learn.microsoft.com/en-us/sql/relational-databases/hierarchical-data-sql-server#enforce-a-tree target=_blank rel=noopener>colonne supplémentaire</a>, nommée <code>parentid</code> par exemple, pour ajouter la
contrainte de clé étrangère. La requête suivante réutilise la fonction <code>subpath()</code> en
s&rsquo;assurant qu&rsquo;une valeur nulle soit insérée s&rsquo;il s&rsquo;agit d&rsquo;un nœud racine.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>DELETE</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&lt;@</span><span class=w> </span><span class=s1>&#39;2&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=n>parentid</span><span class=w> </span><span class=n>ltree</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>GENERATED</span><span class=w> </span><span class=n>ALWAYS</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>CASE</span><span class=w> </span><span class=n>subpath</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>nlevel</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>WHEN</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=k>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>ELSE</span><span class=w> </span><span class=n>subpath</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>nlevel</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>END</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=n>STORED</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>À présent, dès qu&rsquo;une nouvelle ligne est insérée, la contrainte de clé étrangère est
automatiquement vérifiée.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;2.1.1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Unknown&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Continent&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>ERROR:  insert or update on table &#34;locations&#34; violates
</span></span></span><span class=line><span class=cl><span class=go>        foreign key constraint &#34;locations_parentid_fkey&#34;
</span></span></span><span class=line><span class=cl><span class=go>DETAIL:  Key (parentid)=(2.1) is not present in table &#34;locations&#34;.
</span></span></span></code></pre></div><hr><h2 id=une-solution-parmi-dautres>Une solution parmi d&rsquo;autres</h2><p>La méthode de stockage des données hiérarchiques sous forme de chemin est une solution
ingénieuse et disponible facilement avec PostgreSQL. Cependant, il s&rsquo;agit d&rsquo;une extension
du langage SQL et chaque moteur peut proposer une implémentation qui peut radicalement
changer d&rsquo;un système à l&rsquo;autre.</p><p>Comme je l&rsquo;indiquais en introduction, la réponse universelle reste la reconstruction d&rsquo;une
relation hiériarchique à l&rsquo;aide d&rsquo;une requête récursive et la syntaxe <code>WITH RECURSIVE</code>. Pour
reprendre l&rsquo;exemple de la table <code>locations</code>, la liste des villes présentes en Europe pourrait
être obtenue de la manière suivante.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=k>RECURSIVE</span><span class=w> </span><span class=n>loc</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>parentid</span><span class=p>,</span><span class=w> </span><span class=k>location</span><span class=p>,</span><span class=w> </span><span class=n>locationtype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>WHERE</span><span class=w> </span><span class=k>location</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Europe&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>parentid</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=k>location</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>locationtype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>FROM</span><span class=w> </span><span class=n>locations</span><span class=w> </span><span class=n>l</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>JOIN</span><span class=w> </span><span class=n>loc</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>parentid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>loc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>locationtype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;City&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go> id | parentid | location | locationtype
</span></span></span><span class=line><span class=cl><span class=go>----+----------+----------+--------------
</span></span></span><span class=line><span class=cl><span class=go>  4 |        3 | Paris    | City
</span></span></span><span class=line><span class=cl><span class=go>  6 |        5 | Madrid   | City
</span></span></span><span class=line><span class=cl><span class=go>(2 rows)
</span></span></span></code></pre></div></article><aside class=related><h3>Suggestion d'articles</h3><ul class=related-posts><li><a href=https://fljd.in/2024/11/25/substituer-une-variable-dans-un-script-sql/>Substituer une variable dans un script SQL
<small><time datetime=2024-11-25>25 nov 2024</time></small></a></li><li><a href=https://fljd.in/2024/05/28/un-assistant-pour-copier-les-donnees-distantes/>Un assistant pour copier les données distantes
<small><time datetime=2024-05-28>28 mai 2024</time></small></a></li><li><a href=https://fljd.in/2025/06/17/le-partitionnement-par-uuid-v7/>Le partitionnement par UUID v7
<small><time datetime=2025-06-17>17 juin 2025</time></small></a></li></ul></aside></main><footer class=footer><small>&copy; 2019-<time datetime=2025-06-17>2025</time>
— <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.fr>Creative Commons License BY-NC-ND 4.0</a></small></footer></div></body></html>