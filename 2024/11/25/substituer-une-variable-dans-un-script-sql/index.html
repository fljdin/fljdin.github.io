<!doctype html><html lang=fr><head><title>Substituer une variable dans un script SQL</title>
<link rel=stylesheet href=https://fljd.in/css/main.min.css><link rel=apple-touch-icon sizes=180x180 href=/ico/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/ico/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/ico/favicon-16x16.png><link rel=manifest href=/ico/site.webmanifest><meta name=fediverse:creator content="@fljdin@mastodon.tedomum.net"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8></head><body><div class="container content"><header class=homepage><h3 class=homepage-title><a href=/ title="Florent Jardin">Florent Jardin</a>
<small><a href=/index.xml><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#rss"/></svg></a>
<a href=https://mastodon.tedomum.net/@fljdin rel=me><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#mastodon"/></svg></a>
<a href=https://github.com/fljdin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#github"/></svg></a>
<a href=https://www.linkedin.com/in/florent-jardin><svg class="svg-icon"><use xlink:href="https://fljd.in/img/social-icons.svg#linkedin"/></svg></a>
&nbsp;&nbsp;<a href=/conferences>Conférences</a>&nbsp;&nbsp;<a href=/archives>Archives</a>&nbsp;&nbsp;<a href=/a-propos>À propos</a></small></h3></header><main><article class=post><h1 class=post-title>Substituer une variable dans un script SQL</a></h1><p class=post-date><time datetime=2024-11-25>25 nov 2024</time>
- 10 minutes de lecture</p><div class="message translation">This article is available in English: <a href=https://fljd.in/en/2024/11/25/substituting-a-variable-in-a-sql-script/>Substituting a variable in a SQL script</a>
<small>(2024-11-25)</small></div><p>Il est fréquent de vouloir automatiser une tâche répétitive en la scriptant
rapidement, puis à force d&rsquo;itérations, de l&rsquo;enrichir, voire de l&rsquo;intégrer dans
la base de code d&rsquo;un projet. À ce jeu, les outils comme SQL*Plus et psql peuvent
être de puissants alliés et des interpréteurs aussi pertinents que Bash ou
Python.</p><p>Dans le cadre des projets de migration que je mène régulièrement, il m&rsquo;arrive de
tomber sur ces scripts, en grand nombre. Certains ont la particularité de
proposer des paramètres d&rsquo;entrée, traités par SQL*Plus avec le mécanisme très
confortable de substitution de variables. Dans cet article, je partage quelques
astuces pour convertir certains aspects de ces scripts grâce aux fonctionnalités
équivalentes que l&rsquo;on retrouve sur l&rsquo;outil psql de PostgreSQL.</p><hr><h2 id=substituer-une-variable>Substituer une variable&mldr;</h2><p>Comme point de départ, penchons-nous sur la syntaxe supportée par l&rsquo;outil
d&rsquo;Oracle avec un exemple fil rouge. Nous incarnons un utilisateur qui souhaite
obtenir le résultat des ventes d&rsquo;une société factice, en appliquant deux filtres
basés sur un numéro produit et deux dates passées en paramètres.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- sqlplus-report-01.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CONNECT</span><span class=w> </span><span class=k>user</span><span class=o>/</span><span class=n>password</span><span class=o>@</span><span class=k>database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>start_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;2&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>end_date</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>NVL</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>JOIN</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=p>(</span><span class=n>product_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;start_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>AND</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;end_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>QUIT</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sqlplus -S /nolog @sqlplus-report-01.sql <span class=m>20</span> 2024-11-01 2024-11-30
</span></span><span class=line><span class=cl><span class=go>old   3:  WHERE product_id = &amp;product_id
</span></span></span><span class=line><span class=cl><span class=go>new   3:  WHERE product_id = 20
</span></span></span><span class=line><span class=cl><span class=go>old   4:    AND order_date BETWEEN TO_DATE(&#39;&amp;start_date&#39;, &#39;YYYY-MM-DD&#39;)
</span></span></span><span class=line><span class=cl><span class=go>new   4:    AND order_date BETWEEN TO_DATE(&#39;2024-11-01&#39;, &#39;YYYY-MM-DD&#39;)
</span></span></span><span class=line><span class=cl><span class=go>old   5:		      AND TO_DATE(&#39;&amp;end_date&#39;, &#39;YYYY-MM-DD&#39;)
</span></span></span><span class=line><span class=cl><span class=go>new   5:		      AND TO_DATE(&#39;2024-11-30&#39;, &#39;YYYY-MM-DD&#39;)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>TOTAL_AMOUNT
</span></span></span><span class=line><span class=cl><span class=go>------------
</span></span></span><span class=line><span class=cl><span class=go>     1378.98
</span></span></span></code></pre></div><p>Comme nous pouvons l&rsquo;observer, la substitution s&rsquo;opère en SQL*Plus dès que le
caractère <code>&</code> est rencontré, que son contenu soit ou non entouré de guillemets
simples. En début de script, j&rsquo;ai appliqué une stratégie simple en définissant
une variable avec un nom évocateur, pour faciliter la lisibilité et la
maintenance du script et ne plus s&rsquo;accommoder des variables nommées selon leur
position dans la liste des arguments.</p><hr><p>Pour obtenir un résultat équivalent avec psql, nous devons effectuer une
<a href=https://psql-tips.org/psql_tips_all.html#tip037 target=_blank rel=noopener>assignation</a> de variables en dehors du script, avec l&rsquo;option <code>-v</code> ou <code>--set</code>
fournie par psql. Ces variables seront alors substituées dans le script à l&rsquo;aide
du mécanisme d&rsquo;<a href=https://www.postgresql.org/docs/current/app-psql.html#APP-PSQL-INTERPOLATION target=_blank rel=noopener>interpolation</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- psql-report-01.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>\</span><span class=n>pset</span><span class=w> </span><span class=n>footer</span><span class=w> </span><span class=k>off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>JOIN</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=p>(</span><span class=n>product_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>AND</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;end_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f psql-report-01.sql <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>product_id</span><span class=o>=</span><span class=m>20</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>start_date</span><span class=o>=</span><span class=s1>&#39;2024-11-01&#39;</span> -v <span class=nv>end_date</span><span class=o>=</span><span class=s1>&#39;2024-11-30&#39;</span>
</span></span><span class=line><span class=cl><span class=go> total_amount 
</span></span></span><span class=line><span class=cl><span class=go>--------------
</span></span></span><span class=line><span class=cl><span class=go>      1378.98
</span></span></span></code></pre></div><p>La reprise du script original est tout à fait triviale, on y retrouve une
syntaxe similaire avec le caractère <code>:</code> en lieu et place de <code>&</code>. Toutefois, si
la variable doit être comprise entre deux guillemets simples, nous constatons
que le caractère <code>:</code> doit être saisi à l&rsquo;extérieur et non à l&rsquo;intérieur.</p><hr><h2 id=-dans-un-bloc-anonyme>&mldr; dans un bloc anonyme</h2><p>Les choses se gâtent lorsque le script devient plus complexe, et nécessite de
manipuler nos précédentes variables dans un bloc anonyme PL/SQL. Reprenons notre
script pour l&rsquo;enrichir d&rsquo;un message personnalisé si le produit demandé n&rsquo;existe
pas. Une première lecture sur la table <code>products</code> peut, éventuellement,
retourner l&rsquo;exception <code>NO_DATA_FOUND</code> que nous souhaitons intercepter.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- sqlplus-report-02.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CONNECT</span><span class=w> </span><span class=k>user</span><span class=o>/</span><span class=n>password</span><span class=o>@</span><span class=k>database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>start_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;2&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>end_date</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>serveroutput</span><span class=w> </span><span class=k>ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>feedback</span><span class=w> </span><span class=k>OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>verify</span><span class=w> </span><span class=k>OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_id</span><span class=w>    </span><span class=n>products</span><span class=p>.</span><span class=n>product_id</span><span class=o>%</span><span class=k>TYPE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_sum</span><span class=w>   </span><span class=nb>NUMBER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_start</span><span class=w> </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;start_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_end</span><span class=w>   </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;end_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>NVL</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_sum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>p_end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>DBMS_OUTPUT</span><span class=p>.</span><span class=n>PUT_LINE</span><span class=p>(</span><span class=s1>&#39;Total amount: &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>p_sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>WHEN</span><span class=w> </span><span class=n>NO_DATA_FOUND</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DBMS_OUTPUT</span><span class=p>.</span><span class=n>PUT_LINE</span><span class=p>(</span><span class=s1>&#39;Product &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>&amp;</span><span class=n>product_id</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; does not exist&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>QUIT</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sqlplus -S /nolog @sqlplus-report-02.sql <span class=m>120</span> 2024-11-01 2024-11-30
</span></span><span class=line><span class=cl><span class=go>Product 120 does not exist
</span></span></span></code></pre></div><hr><p>Du côté de notre alternative PostgreSQL et son invite de commande psql, il
apparaît qu&rsquo;un bloc anonyme en PL/pgSQL ne permet pas de réaliser la
substitution comme nous le souhaitons. Si nous tentons de réaliser un contrôle
avec le renvoi d&rsquo;une exception, nous obtenons une erreur de syntaxe, car la
variable n&rsquo;est pas substituée.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- psql-report-02-wrong.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DO</span><span class=w> </span><span class=err>$$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_id</span><span class=w>    </span><span class=n>products</span><span class=p>.</span><span class=n>product_id</span><span class=o>%</span><span class=k>TYPE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_sum</span><span class=w>   </span><span class=nb>numeric</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_start</span><span class=w> </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_end</span><span class=w>   </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;end_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=k>STRICT</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_sum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>p_end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Total amount: %&#39;</span><span class=p>,</span><span class=w> </span><span class=n>p_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>WHEN</span><span class=w> </span><span class=n>no_data_found</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Product % does not exist&#39;</span><span class=p>,</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>$$</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f psql-report-02-wrong.sql <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>product_id</span><span class=o>=</span><span class=m>120</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>start_date</span><span class=o>=</span><span class=s1>&#39;2024-11-01&#39;</span> -v <span class=nv>end_date</span><span class=o>=</span><span class=s1>&#39;2024-11-30&#39;</span>
</span></span><span class=line><span class=cl><span class=go>psql:psql-report-02-wrong.sql:25: ERROR:  syntax error at or near &#34;:&#34;
</span></span></span><span class=line><span class=cl><span class=go>LINE 5:   p_start date := :&#39;start_date&#39;::date;
</span></span></span><span class=line><span class=cl><span class=go>                          ^
</span></span></span></code></pre></div><p>Fort heureusement, psql ne nous laisse pas sans ressource. Les méta-commandes
qu&rsquo;il propose peuvent nous permettre d&rsquo;obtenir le même résultat, moyennant une
réécriture plus profonde du script. Nous allons utiliser la méta-commande
<code>\gset</code> pour stocker l&rsquo;état du produit puis la méta-commande <code>\if</code> pour réaliser
le contrôle.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- psql-report-02.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>\</span><span class=n>pset</span><span class=w> </span><span class=n>footer</span><span class=w> </span><span class=k>off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>unknown_product</span><span class=w> </span><span class=err>\</span><span class=n>gset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>\</span><span class=k>if</span><span class=w> </span><span class=p>:</span><span class=n>unknown_product</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>\</span><span class=n>echo</span><span class=w> </span><span class=s1>&#39;Product&#39;</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w> </span><span class=s1>&#39;does not exist&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>\</span><span class=n>quit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>\</span><span class=n>endif</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>JOIN</span><span class=w> </span><span class=n>products</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=p>(</span><span class=n>product_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=k>AND</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;end_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f report.sql <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>product_id</span><span class=o>=</span><span class=m>120</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>start_date</span><span class=o>=</span><span class=s1>&#39;2024-11-01&#39;</span> -v <span class=nv>end_date</span><span class=o>=</span><span class=s1>&#39;2024-11-30&#39;</span>
</span></span><span class=line><span class=cl><span class=go>Product 120 does not exist
</span></span></span></code></pre></div><hr><h2 id=-à-tout-prix>&mldr; à tout prix</h2><p>Il est probable que les méta-commandes de psql ne viennent pas à bout de toutes
les ingéniosités (et aberrations) que peuvent réserver les scripts compatibles
avec SQL*Plus. Progressons encore avec une évolution plus complexe de notre
exemple.</p><p>Notre utilisateur souhaite à présent obtenir un score de performance pour la
période de vente de son produit, en comparant avec la période précédente. Nous
aurions besoin ici d&rsquo;un curseur pour réutiliser plusieurs fois la même requête
de calcul des ventes ainsi que d&rsquo;une fonction pour calculer le score de
performance en gérant correctement la division possible par zéro.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- sqlplus-report-03.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CONNECT</span><span class=w> </span><span class=k>user</span><span class=o>/</span><span class=n>password</span><span class=o>@</span><span class=k>database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>start_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;2&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DEF</span><span class=w> </span><span class=n>end_date</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&amp;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>serveroutput</span><span class=w> </span><span class=k>ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>feedback</span><span class=w> </span><span class=k>OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>verify</span><span class=w> </span><span class=k>OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_id</span><span class=w>         </span><span class=n>products</span><span class=p>.</span><span class=n>product_id</span><span class=o>%</span><span class=k>TYPE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_sum</span><span class=w>        </span><span class=nb>NUMBER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_sum</span><span class=w>   </span><span class=nb>NUMBER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_start</span><span class=w>      </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;start_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_end</span><span class=w>        </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>TO_DATE</span><span class=p>(</span><span class=s1>&#39;&amp;end_date&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;YYYY-MM-DD&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_start</span><span class=w> </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>(</span><span class=n>p_end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>p_start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_end</span><span class=w>   </span><span class=nb>DATE</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CURSOR</span><span class=w> </span><span class=n>c_orders</span><span class=w> </span><span class=p>(</span><span class=n>v_start</span><span class=w> </span><span class=nb>DATE</span><span class=p>,</span><span class=w> </span><span class=n>v_end</span><span class=w> </span><span class=nb>DATE</span><span class=p>)</span><span class=w> </span><span class=k>IS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>v_start</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>v_end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FUNCTION</span><span class=w> </span><span class=n>score</span><span class=p>(</span><span class=n>p_sum</span><span class=w> </span><span class=nb>NUMBER</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=nb>NUMBER</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>RETURN</span><span class=w> </span><span class=nb>NUMBER</span><span class=w> </span><span class=k>IS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>v_score</span><span class=w> </span><span class=nb>NUMBER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>RETURN</span><span class=w> </span><span class=n>ROUND</span><span class=p>((</span><span class=n>p_sum</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHEN</span><span class=w> </span><span class=n>ZERO_DIVIDE</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>RETURN</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>OPEN</span><span class=w> </span><span class=n>c_orders</span><span class=p>(</span><span class=n>p_start</span><span class=p>,</span><span class=w> </span><span class=n>p_end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FETCH</span><span class=w> </span><span class=n>c_orders</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CLOSE</span><span class=w> </span><span class=n>c_orders</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>OPEN</span><span class=w> </span><span class=n>c_orders</span><span class=p>(</span><span class=n>p_prev_start</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FETCH</span><span class=w> </span><span class=n>c_orders</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CLOSE</span><span class=w> </span><span class=n>c_orders</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>DBMS_OUTPUT</span><span class=p>.</span><span class=n>PUT_LINE</span><span class=p>(</span><span class=s1>&#39;Total amount: &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>p_sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>DBMS_OUTPUT</span><span class=p>.</span><span class=n>PUT_LINE</span><span class=p>(</span><span class=s1>&#39;Performance score: &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>score</span><span class=p>(</span><span class=n>p_sum</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>WHEN</span><span class=w> </span><span class=n>NO_DATA_FOUND</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DBMS_OUTPUT</span><span class=p>.</span><span class=n>PUT_LINE</span><span class=p>(</span><span class=s1>&#39;Product &#39;</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>&amp;</span><span class=n>product_id</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; does not exist&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>QUIT</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sqlplus -S /nolog @sqlplus-report-03.sql <span class=m>20</span> 2024-11-01 2024-11-30
</span></span><span class=line><span class=cl><span class=go>Total amount: 1378.98
</span></span></span><span class=line><span class=cl><span class=go>Performance score: 162.99
</span></span></span></code></pre></div><p>Bien que l&rsquo;exemple soit volontairement simpliste et qu&rsquo;il puisse faire appel à
une <a href=/2023/02/10/le-fenetrage-a-la-rescousse/>fonction de fenêtrage</a>, nous allons jouer le jeu de la conversion du
script au plus proche de sa syntaxe originale. Pour cela, identifions les
faiblesses du PL/pgSQL.</p><hr><p><strong>Les routines éphémères ne sont pas prises en charge</strong></p><p>Le langage PL/pgSQL n&rsquo;autorise pas la déclaration de fonctions ou de procédures
stockées dont la portée serait exclusive au contexte d&rsquo;exécution. La seule
alternative est de définir globalement la routine, afin qu&rsquo;elle soit connue de
l&rsquo;analyseur syntaxique et exécutée correctement. Dans le cas présent, je ne
souhaite pas que la fonction persiste après l&rsquo;appel de mon script. Qu&rsquo;à cela ne
tienne, nous pouvons créer une fonction temporaire dans le schéma <code>pg_temp</code> !</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- temp-function.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DO</span><span class=w> </span><span class=err>$$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CREATE</span><span class=w> </span><span class=k>FUNCTION</span><span class=w> </span><span class=n>pg_temp</span><span class=p>.</span><span class=n>score</span><span class=p>(</span><span class=n>p_sum</span><span class=w> </span><span class=nb>numeric</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=nb>numeric</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>RETURNS</span><span class=w> </span><span class=nb>numeric</span><span class=w> </span><span class=k>LANGUAGE</span><span class=w> </span><span class=n>plpgsql</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=err>$</span><span class=n>func$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>RETURN</span><span class=w> </span><span class=n>ROUND</span><span class=p>((</span><span class=n>p_sum</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>WHEN</span><span class=w> </span><span class=n>division_by_zero</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>RETURN</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>$</span><span class=n>func$</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Score: %&#39;</span><span class=p>,</span><span class=w> </span><span class=n>pg_temp</span><span class=p>.</span><span class=n>score</span><span class=p>(</span><span class=mi>100</span><span class=p>.</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>50</span><span class=p>.</span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Score: %&#39;</span><span class=p>,</span><span class=w> </span><span class=n>pg_temp</span><span class=p>.</span><span class=n>score</span><span class=p>(</span><span class=mi>100</span><span class=p>.</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>$$</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f temp-function.sql
</span></span><span class=line><span class=cl><span class=go>psql:temp-function.sql:16: NOTICE:  Score: 100.00
</span></span></span><span class=line><span class=cl><span class=go>psql:temp-function.sql:16: NOTICE:  Score: &lt;NULL&gt;
</span></span></span><span class=line><span class=cl><span class=go>DO
</span></span></span></code></pre></div><p>La fonction <code>pg_temp.score(numeric, numeric)</code> est dès lors accessible dans le
reste de notre bloc anonyme, et ce, uniquement pour la durée de la session. La
gestion des exceptions est conforme au besoin, il a suffit de remplacer
<code>ZERO_DIVIDE</code> par <code>division_by_zero</code> comme le stipule la <a href=https://www.postgresql.org/docs/current/errcodes-appendix.html target=_blank rel=noopener>documentation</a>.</p><p><strong>La substitution ne s&rsquo;applique pas dans un bloc anonyme</strong></p><p>Comme nous l&rsquo;avons vu précédemment, la substitution n&rsquo;intervient pas lorsque
nous nous trouvons dans un bloc de code PL/pgSQL. Pour contourner cette
limitation, nous allons devoir utiliser les <a href=https://www.postgresql.org/docs/current/runtime-config-custom.html target=_blank rel=noopener>variables de session
personnalisées</a> mises à disposition pour l&rsquo;écosystème d&rsquo;extensions avec
PostgreSQL.</p><p>Ces variables peuvent être manipulées aussi bien en psql avec le mot-clé <code>SET</code>
qu&rsquo;en SQL ou en PL/pgSQL avec les fonctions <a href=https://pgpedia.info/c/current_setting.html target=_blank rel=noopener><code>current_setting</code></a> et
<a href=https://pgpedia.info/s/set_config.html target=_blank rel=noopener><code>set_config</code></a>. La seule contrainte consiste à leur définir un préfixe qui
n&rsquo;entre pas en conflit avec celui d&rsquo;autres variables déjà déclarées dans notre
instance.</p><p>Pour revenir à notre exercice de conversion, cela signifie que nos paramètres
de script peuvent être montés en variables de session dans les toutes premières
instructions. Dès que nous sommes dans un bloc anonyme, il convient alors de les
rappeler dans des variables classiques comme le montre le code suivant :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>start_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>start_date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>end_date</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>end_date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DO</span><span class=w> </span><span class=err>$$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>my_id</span><span class=w>   </span><span class=nb>int</span><span class=w>  </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.product_id&#39;</span><span class=p>)::</span><span class=nb>int</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_start</span><span class=w> </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.start_date&#39;</span><span class=p>)::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_end</span><span class=w>   </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.end_date&#39;</span><span class=p>)::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>$$</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p><strong>Conversion complète</strong></p><p>Toutes ces astuces mises bout à bout permet d&rsquo;obtenir une nouvelle version du
script, converti de PL/SQL à PL/pgSQL :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- psql-report-03.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>\</span><span class=k>set</span><span class=w> </span><span class=n>QUIET</span><span class=w> </span><span class=k>on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>start_date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>my</span><span class=p>.</span><span class=n>end_date</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;end_date&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DO</span><span class=w> </span><span class=err>$$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>my_id</span><span class=w>        </span><span class=nb>int</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.product_id&#39;</span><span class=p>)::</span><span class=nb>int</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_id</span><span class=w>         </span><span class=n>products</span><span class=p>.</span><span class=n>product_id</span><span class=o>%</span><span class=k>TYPE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_sum</span><span class=w>        </span><span class=nb>numeric</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_sum</span><span class=w>   </span><span class=nb>numeric</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_start</span><span class=w>      </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.start_date&#39;</span><span class=p>)::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_end</span><span class=w>        </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>current_setting</span><span class=p>(</span><span class=s1>&#39;my.end_date&#39;</span><span class=p>)::</span><span class=nb>date</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_start</span><span class=w> </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1 day&#39;</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>p_end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>p_start</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>p_prev_end</span><span class=w>   </span><span class=nb>date</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>p_start</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1 day&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>c_orders</span><span class=w> </span><span class=k>CURSOR</span><span class=w> </span><span class=p>(</span><span class=n>v_start</span><span class=w> </span><span class=nb>date</span><span class=p>,</span><span class=w> </span><span class=n>v_end</span><span class=w> </span><span class=nb>date</span><span class=p>)</span><span class=w> </span><span class=k>IS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>AND</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>v_start</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>v_end</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CREATE</span><span class=w> </span><span class=k>FUNCTION</span><span class=w> </span><span class=n>pg_temp</span><span class=p>.</span><span class=n>score</span><span class=p>(</span><span class=n>p_sum</span><span class=w> </span><span class=nb>numeric</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=nb>numeric</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>RETURNS</span><span class=w> </span><span class=nb>numeric</span><span class=w> </span><span class=k>LANGUAGE</span><span class=w> </span><span class=n>plpgsql</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=err>$</span><span class=n>func$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>RETURN</span><span class=w> </span><span class=n>ROUND</span><span class=p>((</span><span class=n>p_sum</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>p_prev_sum</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>WHEN</span><span class=w> </span><span class=n>division_by_zero</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>RETURN</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>$</span><span class=n>func$</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=k>STRICT</span><span class=w> </span><span class=n>p_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>my_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>OPEN</span><span class=w> </span><span class=n>c_orders</span><span class=p>(</span><span class=n>p_start</span><span class=p>,</span><span class=w> </span><span class=n>p_end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FETCH</span><span class=w> </span><span class=n>c_orders</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CLOSE</span><span class=w> </span><span class=n>c_orders</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>OPEN</span><span class=w> </span><span class=n>c_orders</span><span class=p>(</span><span class=n>p_prev_start</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_end</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FETCH</span><span class=w> </span><span class=n>c_orders</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>CLOSE</span><span class=w> </span><span class=n>c_orders</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Total amount: %&#39;</span><span class=p>,</span><span class=w> </span><span class=n>p_sum</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Performance score: %&#39;</span><span class=p>,</span><span class=w> </span><span class=n>pg_temp</span><span class=p>.</span><span class=n>score</span><span class=p>(</span><span class=n>p_sum</span><span class=p>,</span><span class=w> </span><span class=n>p_prev_sum</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXCEPTION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>WHEN</span><span class=w> </span><span class=n>no_data_found</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RAISE</span><span class=w> </span><span class=n>NOTICE</span><span class=w> </span><span class=s1>&#39;Product % does not exist&#39;</span><span class=p>,</span><span class=w> </span><span class=n>my_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>$$</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f psql-report-03.sql<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>product_id</span><span class=o>=</span><span class=m>20</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>start_date</span><span class=o>=</span><span class=s1>&#39;2024-11-01&#39;</span> -v <span class=nv>end_date</span><span class=o>=</span><span class=s1>&#39;2024-11-30&#39;</span> 
</span></span><span class=line><span class=cl><span class=go>psql:psql-report-03.sql:55: NOTICE:  Total amount: 1378.98
</span></span></span><span class=line><span class=cl><span class=go>psql:psql-report-03.sql:55: NOTICE:  Performance score: 162.99
</span></span></span></code></pre></div><hr><h2 id=conclusion>Conclusion</h2><p>Convertir un script SQL*Plus pour qu&rsquo;il devienne compatible avec l&rsquo;outil psql de
PostgreSQL est un exercice surmontable, pour peu que l&rsquo;on connaisse les bonnes
astuces et alternatives qui répondent au besoin initial. Bien sûr, une
traduction un pour un, en conservant la syntaxe et un semblant de lisibilité,
pourrait s&rsquo;avérer plus ardue que l&rsquo;exemple que j&rsquo;ai concocté.</p><p>Je reste toujours sceptique face à celles et ceux qui souhaitent conserver ce
genre de pratiques de développement, que je trouve obsolètes. Migrer vers
PostgreSQL n&rsquo;est-il pas l&rsquo;occasion de moderniser sa base de code, ou de
questionner son rapport à la technologie ? Dans notre exemple, comme je l&rsquo;avais
mentionné, il est possible d&rsquo;obtenir le même résultat en une seule requête SQL,
sans avoir à recourir à un bloc anonyme PL/pgSQL.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- psql-report-04.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>\</span><span class=n>pset</span><span class=w> </span><span class=n>footer</span><span class=w> </span><span class=k>off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>unknown_product</span><span class=w> </span><span class=err>\</span><span class=n>gset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>\</span><span class=k>if</span><span class=w> </span><span class=p>:</span><span class=n>unknown_product</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>\</span><span class=n>echo</span><span class=w> </span><span class=s1>&#39;Product&#39;</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w> </span><span class=s1>&#39;does not exist&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>\</span><span class=n>quit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>\</span><span class=n>endif</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;end_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>days</span><span class=w> </span><span class=err>\</span><span class=n>gset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>:</span><span class=n>days</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>prev_start</span><span class=w> </span><span class=err>\</span><span class=n>gset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WITH</span><span class=w> </span><span class=n>periods</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>start_date</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>:</span><span class=n>days</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s1>&#39;1 day&#39;</span><span class=p>::</span><span class=nb>interval</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>end_date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>generate_series</span><span class=p>(:</span><span class=s1>&#39;prev_start&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=p>:</span><span class=s1>&#39;start_date&#39;</span><span class=p>::</span><span class=nb>date</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                         </span><span class=p>:</span><span class=n>days</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=s1>&#39;1 day&#39;</span><span class=p>::</span><span class=nb>interval</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>s</span><span class=p>(</span><span class=n>d</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>),</span><span class=w> </span><span class=n>amounts</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>start_date</span><span class=p>,</span><span class=w> </span><span class=n>COALESCE</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>total_amount</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>LAG</span><span class=p>(</span><span class=k>SUM</span><span class=p>(</span><span class=n>amount</span><span class=p>),</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>start_date</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>prev_total_amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>orders</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>JOIN</span><span class=w> </span><span class=n>periods</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>order_date</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=n>start_date</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>end_date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>product_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>product_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>start_date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>total_amount</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>ROUND</span><span class=p>((</span><span class=n>total_amount</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>prev_total_amount</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>prev_total_amount</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>performance_score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>amounts</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>prev_total_amount</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> psql -f psql-report-04.sql<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>product_id</span><span class=o>=</span><span class=m>20</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=gp>$</span>      -v <span class=nv>start_date</span><span class=o>=</span><span class=s1>&#39;2024-11-01&#39;</span> -v <span class=nv>end_date</span><span class=o>=</span><span class=s1>&#39;2024-11-30&#39;</span> 
</span></span><span class=line><span class=cl><span class=go> total_amount | performance_score 
</span></span></span><span class=line><span class=cl><span class=go>--------------+-------------------
</span></span></span><span class=line><span class=cl><span class=go>      1378.98 |            162.99 
</span></span></span></code></pre></div><div class=message>Tous les scripts de cet article, ainsi que les commandes DDL pour construire
le modèle de données, sont disponibles cette <a href=https://gist.github.com/fljdin/45d9ece1c9aba054c85cfbede09c95fd target=_blank rel=noopener>adresse</a>.</div></article><aside class=related><h3>Suggestion d'articles</h3><ul class=related-posts><li><a href=https://fljd.in/2024/05/28/un-assistant-pour-copier-les-donnees-distantes/>Un assistant pour copier les données distantes
<small><time datetime=2024-05-28>28 mai 2024</time></small></a></li><li><a href=https://fljd.in/2023/07/28/en-route-vers-la-liberte-avec-db_migrator/>En route vers la liberté avec db_migrator
<small><time datetime=2023-07-28>28 juil 2023</time></small></a></li><li><a href=https://fljd.in/2024/09/19/les-types-hierarchiques/>Les types hiérarchiques
<small><time datetime=2024-09-19>19 sept 2024</time></small></a></li></ul></aside></main><footer class=footer><small>&copy; 2019-<time datetime=2025-06-17>2025</time>
— <a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.fr>Creative Commons License BY-NC-ND 4.0</a></small></footer></div></body></html>